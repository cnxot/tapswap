
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Xot_swap - Power Play</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /*
         * Xot_swap Power Play - Main Stylesheet
         * Version: 1.0.1
         * Author: XotSwap Team
         * Description: Comprehensive styling for the Telegram Web App.
         */

        :root {
            /* Telegram Theme Variables (Defaults, will be overridden if TG provides them) */
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #707579;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;

            /* Custom App Theme Variables */
            --primary-color: var(--tg-theme-button-color, #007bff); /* Deep Sky Blue */
            --secondary-color: #17a2b8; /* Pacific Blue */
            --accent-color: #ffc107; /* Golden Yellow */
            --accent-color-darker: #e0a800; /* Darker Golden Yellow for hovers */
            --background-color: var(--tg-theme-bg-color, #f4f4f9); /* Light Lavender Gray */
            --card-background: var(--tg-theme-secondary-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #343a40); /* Dark Gray */
            --nav-background: var(--tg-theme-secondary-bg-color, #ffffff);
            --nav-text-color: var(--tg-theme-hint-color, #6c757d); /* Medium Gray */
            --nav-active-color: var(--primary-color);
            --button-color: var(--primary-color);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --energy-bar-background: #e9ecef; /* Light Gray */
            --energy-bar-fill: linear-gradient(90deg, var(--accent-color), #ffd700); /* Gold Gradient */
            --points-color: var(--primary-color);
            --success-color: #28a745; /* Green */
            --danger-color: #dc3545; /* Red */
            --info-color: #17a2b8; /* Teal */
            --warning-color: #ffc107; /* Yellow */

            /* Dimensions & Spacing */
            --header-height: 55px;
            --nav-height: 65px;
            --button-padding: 12px 24px;
            --button-font-size: 1em;
            --card-border-radius: 15px;
            --button-border-radius: 10px;
            --container-padding: 20px;
            --item-spacing: 15px;

            /* Typography */
            --font-family-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-size-small: 0.85em;
            --font-size-medium: 1em;
            --font-size-large: 1.2em;
            --font-size-xlarge: 1.5em;
            --font-size-xxlarge: 2em;
            --font-size-points: 2.8em;

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 6px 15px rgba(0,0,0,0.12);

            /* Transitions */
            --transition-fast: 0.15s ease-out;
            --transition-medium: 0.3s ease-out;
        }

        /* Global Reset & Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            -webkit-text-size-adjust: 100%; /* Prevent font scaling in landscape */
        }

        body {
            font-family: var(--font-family-main);
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100); /* Fallback for vh units on mobile */
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
            font-size: var(--font-size-medium);
            line-height: 1.6;
        }

        /* App Header */
        #app-header {
            background: linear-gradient(135deg, var(--primary-color), color-mix(in srgb, var(--primary-color) 80%, black));
            color: var(--button-text-color);
            text-align: center;
            padding: 0 15px;
            font-size: var(--font-size-large);
            font-weight: 600;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }
        #app-header img.header-logo {
            height: 30px;
            margin-right: 10px;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
        }

        /* Content Area */
        .content-area {
            flex-grow: 1;
            padding-top: var(--header-height);
            padding-bottom: var(--nav-height);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Page Transitions */
        .page {
            display: none;
            padding: var(--container-padding);
            min-height: calc(100% - (var(--container-padding) * 2));
            animation-duration: var(--transition-medium);
            animation-fill-mode: forwards;
        }

        .page.active {
            display: block;
            animation-name: pageFadeIn;
        }
        
        .page.exiting {
            animation-name: pageFadeOut;
        }

        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pageFadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-15px); }
        }


        /* Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--nav-background);
            display: flex;
            justify-content: space-around;
            align-items: stretch; /* Ensure buttons fill height */
            border-top: 1px solid color-mix(in srgb, var(--nav-text-color) 20%, transparent);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
            z-index: 1000;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--nav-text-color);
            font-size: 10px; /* Slightly smaller for more icon space */
            font-weight: 500;
            cursor: pointer;
            padding: 6px 5px; /* Adjusted padding */
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: color var(--transition-fast), background-color var(--transition-fast);
            position: relative;
        }
        
        .nav-btn svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            fill: currentColor; /* Inherit color from parent for easier state changes */
            transition: transform var(--transition-fast);
        }

        .nav-btn:hover {
            background-color: color-mix(in srgb, var(--nav-active-color) 10%, transparent);
        }

        .nav-btn.active {
            color: var(--nav-active-color);
            font-weight: 600;
        }
        
        .nav-btn.active svg {
            /* fill: var(--nav-active-color); // Not needed if using currentColor */
            transform: scale(1.1); /* Slight scale effect for active icon */
        }
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background-color: var(--nav-active-color);
            border-radius: 3px 3px 0 0;
        }


        /* Tap Page Specifics */
        #page-tap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Distribute elements nicely */
            text-align: center;
            padding: 10px; /* Reduced padding to maximize space */
            gap: 15px; /* Spacing between main elements */
        }

        .tap-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 5px; /* Minimal horizontal padding */
            gap: 10px;
        }
        .tap-header-info > div {
            background-color: var(--card-background);
            padding: 8px 12px;
            border-radius: var(--card-border-radius);
            box-shadow: var(--shadow-sm);
            font-size: var(--font-size-small);
            font-weight: 500;
            flex-grow: 1;
            text-align: center;
        }
        #profit-per-hour-display, #level-display {
            white-space: nowrap;
        }

        #points-display-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0; /* Vertical margin */
            flex-direction: column; /* Stack coin and points */
        }
        #points-display-icon {
            width: 40px; /* Larger coin icon */
            height: 40px;
            margin-bottom: 5px;
            /* background-image: url('your-coin-icon.svg'); SVG preferred */
            /* background-size: contain; */
            /* background-repeat: no-repeat; */
            /* For demo, using accent color circle */
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--button-text-color);
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #points-display {
            font-size: var(--font-size-points);
            font-weight: 700; /* Bolder */
            color: var(--points-color);
            line-height: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #tap-button-container {
            position: relative; /* For floating scores */
            margin: 10px 0; /* Vertical margin */
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; /* Full width for centering */
        }
        #tap-button {
            width: clamp(200px, 65vw, 280px); /* Responsive size */
            height: clamp(200px, 65vw, 280px);
            cursor: pointer;
            border-radius: 50%;
            background-color: var(--card-background);
            background-image: radial-gradient(circle, color-mix(in srgb, var(--accent-color) 20%, transparent) 0%, transparent 70%);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15), 0 0 0 8px color-mix(in srgb, var(--accent-color) 30%, transparent); /* Enhanced glow */
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            overflow: hidden;
        }
        #tap-button:active {
            transform: scale(0.94);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2), 0 0 0 5px color-mix(in srgb, var(--accent-color) 50%, transparent);
        }
        #tap-image {
            width: 85%; /* Adjust if image has padding */
            height: 85%;
            object-fit: contain;
            border-radius: 50%; /* If image itself isn't round */
            pointer-events: none; /* Prevent image from interfering with tap */
            transition: transform 0.1s ease-out;
        }
        #tap-button:active #tap-image {
            transform: scale(1.05); /* Subtle image pop on tap */
        }

        #energy-container {
            width: 95%;
            max-width: 400px;
            text-align: center;
            padding: 10px;
            background-color: var(--card-background);
            border-radius: var(--card-border-radius);
            box-shadow: var(--shadow-sm);
        }
        #energy-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: var(--font-size-medium);
        }
        #energy-text { 
            color: var(--text-color); 
            font-weight: 500;
        }
        #boost-full-energy-btn { /* Renamed for clarity */
            background-color: var(--accent-color);
            color: var(--text-color); /* Better contrast on yellow */
            border: none;
            padding: 8px 14px;
            border-radius: var(--button-border-radius);
            font-size: var(--font-size-small);
            font-weight: 600;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        #boost-full-energy-btn:hover {
            background-color: var(--accent-color-darker);
        }
        #boost-full-energy-btn:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #energy-bar-bg {
            background-color: var(--energy-bar-background);
            border-radius: 20px; /* More rounded */
            height: 24px;
            overflow: hidden;
            margin-top: 8px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative; /* For percentage text */
        }
        #energy-bar-fill {
            background: var(--energy-bar-fill);
            width: 100%;
            height: 100%;
            border-radius: 20px; /* Match parent */
            transition: width 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #energy-percentage-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.4);
            opacity: 0; /* Hidden by default, shown if not enough contrast */
        }
        /* Logic to show text if bar is too short or color too light would be in JS or advanced CSS */

        /* Floating tap score animation */
        .tap-score-animation {
            position: absolute;
            font-size: var(--font-size-xlarge); /* Larger floating score */
            color: var(--accent-color);
            font-weight: bold;
            user-select: none;
            pointer-events: none;
            animation: floatUpAndFade 1.2s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Added easing */
            text-shadow: 0 0 8px rgba(0,0,0,0.4);
            z-index: 101; /* Above tap button */
        }
        @keyframes floatUpAndFade {
            0% { opacity: 1; transform: translateY(0) scale(0.8); }
            20% { opacity: 0.9; transform: translateY(-20px) scale(1.1); }
            100% { opacity: 0; transform: translateY(-80px) scale(0.9); }
        }

        /* General UI Elements */
        .card {
            background-color: var(--card-background);
            padding: var(--container-padding);
            margin-bottom: var(--item-spacing);
            border-radius: var(--card-border-radius);
            box-shadow: var(--shadow-md);
            transition: box-shadow var(--transition-medium), transform var(--transition-medium);
        }
        .card:hover {
            /* box-shadow: var(--shadow-lg); */ /* Can be too much on mobile */
        }
        .card-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid color-mix(in srgb, var(--text-color) 10%, transparent);
        }
        .card-header h2, .card-header h3 {
            margin-top: 0;
            margin-bottom: 5px; /* Added margin for subtitle */
            color: var(--primary-color);
        }
        .card-header p.subtitle {
            font-size: var(--font-size-small);
            color: var(--tg-theme-hint-color);
            margin-top: 0;
        }

        button.primary-btn, input[type="submit"].primary-btn {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: var(--button-padding);
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-size: var(--button-font-size);
            font-weight: 600;
            width: 100%;
            text-align: center;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
            display: inline-flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
        }
        button.primary-btn:hover:not(:disabled) { 
            background-color: color-mix(in srgb, var(--button-color) 85%, black);
            transform: translateY(-1px); /* Subtle lift */
        }
        button.primary-btn:active:not(:disabled) { 
            transform: scale(0.98) translateY(0); 
        }
        button.primary-btn:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        button.secondary-btn {
            background-color: var(--card-background);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        button.secondary-btn:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }


        /* Profile Page */
        #page-profile .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--item-spacing);
            padding-bottom: var(--item-spacing);
            border-bottom: 1px solid #eee;
        }
        #profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: bold;
            margin-right: 15px;
            object-fit: cover; /* If using an image */
        }
        #profile-greeting h2 { margin: 0 0 5px 0; }
        #profile-greeting p { font-size: var(--font-size-small); color: var(--tg-theme-hint-color); margin: 0;}

        #page-profile .profile-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #page-profile .profile-item:last-child { border-bottom: none; }
        #page-profile .profile-item-label { font-weight: 500; color: var(--text-color); }
        #page-profile .profile-item-value { color: var(--primary-color); font-weight: 600; text-align: right;}
        #profile-referral-link-container { margin-top: var(--item-spacing); }
        #profile-referral-link {
            display: block; /* Make it block for better tap area */
            padding: 12px;
            background-color: var(--background-color);
            border: 1px dashed var(--primary-color);
            border-radius: var(--button-border-radius);
            word-break: break-all;
            margin-top: 5px;
            cursor: pointer;
            text-align: center;
            color: var(--primary-color);
            font-weight: 500;
            transition: background-color var(--transition-fast);
        }
        #profile-referral-link:hover {
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: var(--item-spacing);
        }
        .stat-card {
            background-color: var(--background-color);
            padding: 15px;
            border-radius: var(--button-border-radius);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        .stat-card .stat-value {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--primary-color);
            display: block;
        }
        .stat-card .stat-label {
            font-size: 0.8em;
            color: var(--tg-theme-hint-color);
        }

        /* Task Page & Upgrade Page Common List Item Styles */
        .list-item {
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: var(--card-border-radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }
        .list-item:hover {
             transform: translateY(-2px);
             box-shadow: var(--shadow-md);
        }
        .list-item-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border-radius: 8px;
            background-color: var(--accent-color); /* Placeholder */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
        }
        .list-item-icon img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .item-info { flex-grow: 1; margin-right: 10px; }
        .item-name { font-weight: 600; font-size: 1.05em; color: var(--text-color); }
        .item-description, .item-effect, .item-reward { 
            font-size: var(--font-size-small); 
            color: var(--tg-theme-hint-color); 
            margin-top: 4px; 
            line-height: 1.4;
        }
        .item-action button {
            padding: 10px 18px;
            font-size: var(--font-size-small);
            font-weight: 600;
            min-width: 90px; /* Ensure buttons have a decent width */
        }
        .item-action .cost, .item-action .level {
            display: block;
            font-size: var(--font-size-small);
            color: var(--points-color);
            margin-bottom: 5px;
            text-align: right;
            font-weight: 500;
        }
        .item-action .level { color: var(--secondary-color); }

        /* Task Page Specifics */
        #task-list { list-style: none; padding: 0; }
        .task-item.completed .item-info .item-name {
            text-decoration: line-through;
            color: var(--tg-theme-hint-color);
        }
        .task-action button.completed { 
            background-color: var(--success-color); 
            border-color: var(--success-color);
            pointer-events: none; /* Disable clicks */
        }
        .task-action button.completed:hover {
            background-color: color-mix(in srgb, var(--success-color) 85%, black);
        }


        /* Upgrades Page Specifics */
        #page-upgrades .upgrade-category {
            margin-bottom: var(--item-spacing);
        }
        #page-upgrades .upgrade-category h3 {
            /* Use card-header style or make a specific one */
            font-size: var(--font-size-large);
            color: var(--secondary-color);
            padding-bottom: 8px;
            margin-bottom: var(--item-spacing);
            border-bottom: 2px solid var(--secondary-color);
        }
        /* .upgrade-item is now .list-item */
        .upgrade-item .item-info .current-effect {
            font-size: var(--font-size-small);
            color: var(--success-color);
            font-weight: 500;
        }


        /* Frens Page */
        #page-frens .frens-header {
            text-align: center;
            margin-bottom: var(--item-spacing);
        }
        #page-frens .frens-header .invite-bonus {
            font-size: var(--font-size-small);
            color: var(--success-color);
            font-weight: 500;
        }
        .fren-item { /* Uses .list-item styles */ }
        .fren-item .fren-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .fren-item .fren-name { font-weight: 600; }
        .fren-item .fren-bonus { font-size: var(--font-size-small); color: var(--success-color); }
        #frens-list-container { max-height: 400px; overflow-y: auto; padding-right: 5px;} /* For scrollable list */
        #no-frens-message {
            text-align: center;
            color: var(--tg-theme-hint-color);
            padding: 20px;
            font-style: italic;
        }
        .leaderboard-toggle {
            text-align: center;
            margin-bottom: var(--item-spacing);
        }
        .leaderboard-toggle button {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 15px;
            border-radius: 20px;
            margin: 0 5px;
        }
        .leaderboard-toggle button.active {
            background: var(--primary-color);
            color: var(--button-text-color);
        }


        /* Boosts Page */
        #page-boosts .boost-item { /* Uses .list-item styles */ }
        .boost-item .item-description { margin-bottom: 5px; }
        .boost-item .boost-timer, .boost-item .boost-uses {
            font-size: var(--font-size-small);
            color: var(--primary-color);
            font-weight: 500;
        }
        .boost-item.active .item-icon {
            border: 2px solid var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
        }
        .boost-item button:disabled {
            background-color: var(--tg-theme-hint-color) !important; /* Ensure override */
        }
        

        /* Withdraw Page */
        #page-withdraw .form-group { margin-bottom: var(--item-spacing); }
        #page-withdraw label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: var(--text-color);
        }
        #page-withdraw input[type="number"], 
        #page-withdraw input[type="text"], 
        #page-withdraw select {
            width: 100%; /* Full width */
            padding: 12px 15px;
            border: 1px solid #ced4da; /* Standard border */
            border-radius: var(--button-border-radius);
            font-size: var(--font-size-medium);
            background-color: var(--background-color); /* Match page bg for better integration */
            color: var(--text-color);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }
        #page-withdraw input:focus, #page-withdraw select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem color-mix(in srgb, var(--primary-color) 30%, transparent);
            outline: none;
        }
        #withdraw-message { 
            margin-top: var(--item-spacing); 
            text-align:center; 
            font-weight: 500; 
            padding: 10px;
            border-radius: var(--button-border-radius);
        }
        #withdraw-message.success { background-color: color-mix(in srgb, var(--success-color) 20%, transparent); color: var(--success-color); }
        #withdraw-message.error { background-color: color-mix(in srgb, var(--danger-color) 20%, transparent); color: var(--danger-color); }
        
        .withdraw-history-title {
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: var(--font-size-large);
            color: var(--secondary-color);
        }
        .history-item {
            background-color: var(--tg-theme-secondary-bg-color, #f9f9f9);
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: var(--button-border-radius);
            font-size: var(--font-size-small);
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .history-item .amount { font-weight: bold; color: var(--primary-color); }
        .history-item .status { font-style: italic; }
        .history-item .status.pending { color: var(--warning-color); }
        .history-item .status.completed { color: var(--success-color); }
        .history-item .status.failed { color: var(--danger-color); }


        /* Daily Reward Modal */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-medium);
        }
        .modal-overlay.show { 
            display: flex; 
            opacity: 1;
        }
        .modal-content {
            background-color: var(--card-background);
            margin: auto;
            padding: 25px 30px; /* More padding */
            border-radius: var(--card-border-radius);
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            opacity: 0;
            transition: transform var(--transition-medium) cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity var(--transition-medium); /* Pop animation */
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-content .modal-icon {
            font-size: 3em;
            color: var(--accent-color);
            margin-bottom: 15px;
            animation: bounceIcon 2s infinite;
        }
        @keyframes bounceIcon {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-15px);}
            60% {transform: translateY(-7px);}
        }
        .modal-content h2 { 
            color: var(--primary-color); 
            margin-top: 0; 
            margin-bottom: 10px;
            font-size: var(--font-size-xlarge);
        }
        .modal-content p { 
            margin-bottom: 20px; 
            font-size: var(--font-size-medium);
            line-height: 1.5;
            color: var(--text-color);
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .modal-actions button {
            flex-grow: 1;
        }


        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: bold; }
        .font-semibold { font-weight: 600; }
        .text-primary { color: var(--primary-color); }
        .text-secondary { color: var(--secondary-color); }
        .text-accent { color: var(--accent-color); }
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-hint { color: var(--tg-theme-hint-color); }
        
        .mt-1 { margin-top: 10px !important; }
        .mt-2 { margin-top: 20px !important; }
        .mt-3 { margin-top: 30px !important; }
        .mb-1 { margin-bottom: 10px !important; }
        .mb-2 { margin-bottom: 20px !important; }
        .mb-3 { margin-bottom: 30px !important; }
        .p-1 { padding: 10px !important; }
        .p-2 { padding: 20px !important; }

        .w-100 { width: 100% !important; }
        .d-none { display: none !important; } /* Use .hidden for consistency */
        .hidden { display: none !important; }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px); /* Position above nav bar */
            left: 50%;
            transform: translateX(-50%) translateY(20px); /* Initial position for animation */
            background-color: rgba(30,30,30,0.9); /* Dark, slightly transparent */
            color: white;
            padding: 14px 22px;
            border-radius: 25px; /* Pill shape */
            font-size: var(--font-size-small);
            font-weight: 500;
            z-index: 3000;
            opacity: 0;
            transition: opacity var(--transition-medium) ease, transform var(--transition-medium) ease;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            max-width: 90%;
            text-align: center;
        }
        #toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #toast-notification.success { background-color: color-mix(in srgb, var(--success-color) 80%, black); }
        #toast-notification.error { background-color: color-mix(in srgb, var(--danger-color) 80%, black); }
        #toast-notification.info { background-color: color-mix(in srgb, var(--info-color) 80%, black); }


        /* Loading Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .spinner-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--tg-theme-secondary-bg-color, #f0f0f0); /* Light border */
            border-top-color: var(--primary-color); /* Primary color for spinning part */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Helper for icons in buttons/links */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em; /* Adjust for better alignment with text */
            fill: currentColor;
        }

        /* Prevent selection on non-text elements */
        #tap-button, .nav-btn {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Custom scrollbar for webkit browsers (optional, for desktop view) */
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        .content-area::-webkit-scrollbar-track {
            background: var(--background-color);
        }
        .content-area::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--background-color);
        }

        /* Styles for improved accessibility */
        :focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Placeholder for image if it fails to load */
        img[alt]:after { /* This provides styled alt text if image fails */
            content: attr(alt);
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #eee;
            color: #777;
            font-size: 12px;
            text-align: center;
            padding: 10px; /* Adjust padding as needed */
            box-sizing: border-box; /* Ensure padding is included in width/height */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #tap-image { /* Ensure the image itself is positioned relative for :after to work well */
            position: relative;
        }

    </style>
</head>
<body>
    <div id="app-header">
        <!-- <img src="logo.png" alt="XotSwap" class="header-logo"> -->
        Xot_swap Power Play
    </div>

    <div class="content-area">
        <!-- Profile Page -->
        <div id="page-profile" class="page">
            <div class="profile-header card">
                <div id="profile-avatar">U</div> <!-- Placeholder for user initial or image -->
                <div id="profile-greeting">
                    <h2 id="profile-name-greeting">Welcome, Player!</h2>
                    <p>User ID: <span id="profile-userId"></span></p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>My Stats</h3>
                </div>
                <div class="profile-item">
                    <span class="profile-item-label">üí∞ Current Points</span>
                    <span id="profile-points" class="profile-item-value">0</span>
                </div>
                <div class="profile-item">
                    <span class="profile-item-label">üìà Profit Per Hour</span>
                    <span id="profile-pph" class="profile-item-value">0</span>
                </div>
                 <div class="profile-item">
                    <span class="profile-item-label">‚ö° Max Energy</span>
                    <span id="profile-max-energy" class="profile-item-value">0</span>
                </div>
                <div class="profile-item">
                    <span class="profile-item-label">üëÜ Tap Power</span>
                    <span id="profile-tap-power" class="profile-item-value">0</span>
                </div>
                <div class="profile-item">
                    <span class="profile-item-label">üìÖ Joined</span>
                    <span id="profile-join-date" class="profile-item-value">N/A</span>
                </div>
            </div>

            <div class="card" id="profile-referral-link-container">
                 <div class="card-header">
                    <h3>Referral Program</h3>
                </div>
                <p class="text-hint mb-1">Invite frens and earn bonus points for each fren and their activity!</p>
                <div id="profile-referral-link" onclick="app.copyReferralLink()">
                    <span>üéÅ Tap to copy your referral link</span>
                </div>
            </div>
            
            <div class="card text-center">
                <h3>Game Links</h3>
                <p class="mt-1">Main Bot: <a href="https://t.me/xotswap_bot" target="_blank" class="text-primary">@xotswap_bot</a></p>
                <p>Community Channel: <a href="https://t.me/your_channel_link" target="_blank" class="text-primary">Join Us!</a></p>
                <p>Support: <a href="https://t.me/your_support_link" target="_blank" class="text-primary">Contact Support</a></p>
            </div>
        </div>

        <!-- Tap Page -->
        <div id="page-tap" class="page active">
            <div class="tap-header-info">
                <div id="profit-per-hour-display">PPH: 0</div>
                <div id="league-display" class="hidden">League: Bronze</div> <!-- Example for future -->
                <div id="level-display">Level: 1</div>
            </div>

            <div id="points-display-container">
                <div id="points-display-icon">X</div> <!-- Coin icon placeholder -->
                <div id="points-display">0</div>
            </div>

            <div id="tap-button-container">
                <div id="tap-button" ontouchstart="app.handleTap(event)" onmousedown="app.handleTap(event)">
                    <img id="tap-image" src="https://i.ibb.co/9TRgV9k/hamster-placeholder.png" alt="Tap Me Xot">
                    <!-- If the image above doesn't load, check your browser's developer console (F12) for errors. -->
                    <!-- It could be a network issue, ad blocker, or the image URL might be temporarily unavailable. -->
                </div>
            </div>

            <div id="energy-container">
                <div id="energy-info">
                    <span>‚ö°Ô∏è Energy: <span id="energy-text">500/500</span></span>
                    <button id="boost-full-energy-btn" onclick="app.activateFullEnergyBoost()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 5px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></svg>
                        Refill (<span id="full-energy-boosts-left">3</span>)
                    </button>
                </div>
                <div id="energy-bar-bg">
                    <div id="energy-bar-fill"></div>
                    <!-- <span id="energy-percentage-text">100%</span> -->
                </div>
            </div>
        </div>

        <!-- Upgrades Page -->
        <div id="page-upgrades" class="page">
            <div class="card">
                <div class="card-header">
                    <h2>Upgrades Center</h2>
                    <p class="subtitle">Invest your points to boost your earnings and efficiency.</p>
                </div>
            </div>
            <div id="upgrades-list-container">
                <!-- Upgrade items will be rendered here by JS -->
            </div>
        </div>

        <!-- Boosts Page -->
        <div id="page-boosts" class="page">
            <div class="card">
                 <div class="card-header">
                    <h2>Boosters</h2>
                    <p class="subtitle">Activate powerful temporary boosts for a massive advantage!</p>
                </div>
            </div>
            <div id="boosts-list-container">
                <p class="text-center text-hint mt-2">Daily boosters refresh every 24 hours.</p>
                <!-- Boost items will be rendered here by JS -->
            </div>
        </div>

        <!-- Task Page -->
        <div id="page-task" class="page">
            <div class="card">
                <div class="card-header">
                    <h2>Tasks & Rewards</h2>
                    <p class="subtitle">Complete tasks to earn bonus points and special rewards.</p>
                </div>
            </div>
            <div id="task-categories">
                <!-- Task categories and lists will be rendered here by JS -->
            </div>
        </div>
        
        <!-- Frens Page -->
        <div id="page-frens" class="page">
            <div class="card frens-header">
                <div class="card-header">
                    <h2>Frens & Referrals</h2>
                    <p class="subtitle">Invite your frens and earn together!</p>
                </div>
                <p class="invite-bonus">üéÅ You get <strong id="fren-invite-bonus">1,000</strong> points for each fren!</p>
                <p class="invite-bonus">ü§ù Your fren gets <strong id="fren-welcome-bonus">500</strong> points as a welcome gift!</p>
                <button class="primary-btn mt-2" onclick="app.inviteFren()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    Invite a Fren
                </button>
            </div>

            <div class="card">
                 <div class="card-header">
                    <h3>Your Frens (<span id="frens-count">0</span>)</h3>
                </div>
                <div id="frens-list-container">
                    <ul id="frens-list" class="list-unstyled">
                        <!-- Frens will be rendered here by JS -->
                    </ul>
                    <p id="no-frens-message" class="hidden">You haven't invited any frens yet. Tap the button above to start!</p>
                </div>
            </div>

             <div class="card leaderboard-toggle hidden"> <!-- Placeholder for leaderboard -->
                <button class="active" data-type="frens">My Frens</button>
                <button data-type="global">Global Top</button>
            </div>
        </div>


        <!-- Withdraw Page (Conceptual - Full functionality requires backend) -->
        <div id="page-withdraw" class="page">
            <div class="card">
                <div class="card-header">
                    <h2>Withdraw Points</h2>
                    <p class="subtitle">Convert your in-game points. (Feature under development)</p>
                </div>
                <div class="form-group">
                    <label for="withdraw-amount">Amount to Withdraw:</label>
                    <input type="number" id="withdraw-amount" placeholder="Enter points (e.g., 100000)">
                </div>
                <div class="form-group">
                    <label for="withdraw-method">Withdrawal Method:</label>
                    <select id="withdraw-method">
                        <option value="ton_usdt">USDT (TON Network)</option>
                        <option value="xot_token" disabled>XOT Token (Coming Soon)</option>
                        <option value="paypal" disabled>PayPal (Coming Soon)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw-address">Wallet Address (for USDT TON):</label>
                    <input type="text" id="withdraw-address" placeholder="Enter your TON wallet address">
                </div>
                <button id="submit-withdraw-btn" class="primary-btn mt-2" onclick="app.handleWithdrawRequest()">
                    Request Withdraw
                </button>
                <div id="withdraw-message" class="mt-2"></div>
            </div>

            <div class="card">
                <h3 class="withdraw-history-title">Withdrawal History</h3>
                <ul id="withdraw-history-list" class="list-unstyled">
                    <!-- History items will be rendered by JS -->
                     <li class="history-item">
                        <div>100,000 Points to USDT TON<br><small class="text-hint">Date: 2024-07-28</small></div>
                        <div class="status pending">Pending</div>
                    </li>
                     <li class="history-item">
                        <div>50,000 Points to XOT<br><small class="text-hint">Date: 2024-07-25</small></div>
                        <div class="status completed">Completed</div>
                    </li>
                </ul>
                <p id="no-withdraw-history" class="text-hint text-center mt-1 hidden">No withdrawal history yet.</p>
            </div>
        </div>
    </div>

    <div id="bottom-nav">
        <button class="nav-btn" data-page="page-profile">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Profile
        </button>
        <button class="nav-btn active" data-page="page-tap">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.34 2.34C11.15 2.06 10.03 2 9 2c-2.21 0-4.21.49-5.98 1.35C1.26 4.23 0 6.04 0 8v10c0 1.1.9 2 2 2h7c1.73 0 3.33-.43 4.72-1.21.32-.18.58-.49.71-.85.13-.36.03-.77-.23-1.06l-4.1-4.56c-.35-.38-.86-.46-1.3-.21l-1.31.73c-.2.11-.45.02-.56-.19L6.38 12H4V9.77L8.8 8.33c.38-.12.67-.44.67-.83s-.29-.71-.67-.83L4 5.23V4c0-1.1.9-2 2-2h3.34c.47 0 .93.12 1.33.34l5.83 3.24c.38.21.67.61.67 1.05V14c0 .99-.57 1.85-1.4 2.23-.32.14-.5.48-.5.83v.94c0 1.1.9 2 2 2h3c1.1 0 2-.9 2-2V8c0-1.96-1.26-3.77-3.02-4.65C16.79 2.49 14.79 2 13 2c-.34 0-.67.02-1 .06l-.66.28z"/></svg>
            Tap
        </button>
        <button class="nav-btn" data-page="page-upgrades">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3M3 13.5h2.5L9 17.2V22h6v-4.8l3.5-3.7H21V9h-2.5L15 5.3V0H9v5.3L5.5 9H3v4.5M10 2v3.3L6.8 8.5H4V10h2.67L10 13.67V16h4v-2.33L17.33 10H20V8.5h-2.8L14 5.3V2h-4m2 5c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5Z"/></svg>
            Upgrades
        </button>
        <button class="nav-btn" data-page="page-boosts">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.14 8.11 2 9.82l5.54 5.07L6.28 22 12 18.61 17.72 22l-1.28-7.11L22 9.82l-7.14-1.71L12 2zm0 3.37L13.92 10h4.94l-3.99 3.64 1.48 5.3L12 16.47l-4.35 2.84 1.48-5.3L4.14 10h4.94L12 5.37z"/></svg>
            Boosts
        </button>
        <button class="nav-btn" data-page="page-task">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            Tasks
        </button>
        <button class="nav-btn" data-page="page-frens">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            Frens
        </button>
        <!-- <button class="nav-btn" data-page="page-withdraw">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 4h14v2H5zm0 10h4v6h6v-6h4l-7-7-7 7z"/></svg>
            Withdraw
        </button> -->
    </div>

    <!-- Daily Reward Modal -->
    <div id="daily-reward-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">üéÅ</div>
            <h2>Daily Reward!</h2>
            <p id="daily-reward-message">Welcome back! Claim your daily reward of <strong id="daily-reward-amount">1000</strong> points!</p>
            <div class="modal-actions">
                <button class="primary-btn" id="claim-daily-reward-btn" onclick="app.claimDailyReward()">Claim Now</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon" id="confirmation-modal-icon">‚ùì</div>
            <h2 id="confirmation-modal-title">Confirm Action</h2>
            <p id="confirmation-modal-message">Are you sure you want to proceed?</p>
            <div class="modal-actions">
                <button class="secondary-btn" id="confirmation-modal-cancel-btn">Cancel</button>
                <button class="primary-btn" id="confirmation-modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-notification">Toast message goes here</div>

    <!-- Loading Spinner Overlay -->
    <div id="loading-overlay" class="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <script>
    // Strict mode for better error handling and performance
    'use strict';

    /**
     * Xot_swap Power Play - Main Application Logic
     * Version: 1.0.1
     * Author: XotSwap Team
     * Description: Core JavaScript for the Telegram Web App.
     *
     * For debugging:
     * 1. Set app.config.debugMode = true; below.
     * 2. Open your browser's developer console (usually F12).
     * 3. Check for any error messages.
     *
     * If tap image is not visible:
     * - Check console for image loading errors (404, CORS, etc.).
     * - Ensure your network connection is stable.
     * - Disable ad blockers or browser extensions that might interfere.
     */

    const app = {
        // --- Constants & Configuration ---
        config: {
            appName: "Xot_swap Power Play",
            version: "1.0.1", // Incremented version
            defaultEnergy: 500,
            energyPerTap: 1,
            energyRechargeRate: 1,
            pointsPerTap: 1,
            offlineEarningsMultiplier: 0.2,
            maxOfflineHours: 6,
            dailyRewardBase: 1000,
            fullEnergyBoostsDaily: 3,
            frenInviteBonus: 1000,
            frenWelcomeBonus: 500,
            tapImage: 'https://i.ibb.co/9TRgV9k/hamster-placeholder.png',
            localStoragePrefix: 'xotswap_powerplay_',
            debugMode: false, // << SET TO true FOR DETAILED CONSOLE LOGS >>
        },

        // --- Game State Variables ---
        state: {
            currentPage: 'page-tap',
            points: 0,
            level: 1,
            maxEnergy: 0,
            currentEnergy: 0,
            tapPower: 0,
            profitPerHour: 0,
            lastEnergyUpdateTime: Date.now(),
            lastLoginTime: Date.now(),
            dailyRewardClaimedTime: 0,
            fullEnergyBoostsUsedToday: 0,
            fullEnergyBoostsLastReset: 0,
            upgrades: {},
            tasksCompleted: {},
            frens: [],
            userProfile: {
                id: null,
                firstName: 'Player',
                lastName: '',
                username: 'player',
                photoUrl: null,
                joinDate: new Date().toISOString().split('T')[0]
            },
            settings: {
                hapticsEnabled: true,
                soundEnabled: false,
            },
            availableUpgrades: [],
            availableTasks: [],
            availableBoosts: [],
        },

        // --- DOM Element Cache ---
        elements: {},

        // --- Initialization ---
        init: function() {
            this.log("App Initializing (v" + this.config.version + ")...");
            // Wrap main initialization in try...finally to ensure loading overlay is hidden
            try {
                this.setupTelegramWebApp();
                this.cacheDOMElements(); // Cache elements early, including loadingOverlay
                
                if (!this.elements.loadingOverlay) { // Critical check
                    console.error("FATAL: Loading overlay element not found in cacheDOMElements. UI might not update correctly.");
                }

                this.loadGameState();
                this.initializeGameData();
                this.bindEventListeners();
                this.updateAllUI();
                this.startEnergyRechargeCycle();
                this.navigateToPage(this.state.currentPage, true);
                this.checkDailyReward();
                this.calculateOfflineEarnings();
                this.checkDailyBoostReset();
                
                const setVh = () => {
                    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
                };
                window.addEventListener('resize', setVh);
                setVh();

                this.log("App Initialization logic complete.");

            } catch (e) {
                this.error("CRITICAL ERROR during app.init():", e);
                // Optionally, display a user-friendly error message on the page
                // For now, just log it. The loading overlay will still be hidden by 'finally'.
                if(this.elements.appHeader) { // Try to show error on page
                    this.elements.appHeader.innerHTML = "Error initializing. Please refresh.";
                    this.elements.appHeader.style.backgroundColor = "red";
                }
            } finally {
                this.log("Attempting to hide loading overlay (from finally block).");
                this.hideLoadingOverlay(); // Ensure this is always called
                this.log("App Initialization finished (or errored out).");
            }
        },

        setupTelegramWebApp: function() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    
                    if (tg.themeParams) this.applyTheme(tg.themeParams);
                    tg.onEvent('themeChanged', () => this.applyTheme(tg.themeParams));

                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        const user = tg.initDataUnsafe.user;
                        this.state.userProfile.id = user.id;
                        this.state.userProfile.firstName = user.first_name || 'Player';
                        this.state.userProfile.lastName = user.last_name || '';
                        this.state.userProfile.username = user.username || `user${user.id}`;
                        this.state.userProfile.photoUrl = user.photo_url || null;
                        this.log("Telegram user data loaded:", this.state.userProfile);
                    } else {
                        this.log("Telegram user data not available. Using defaults.");
                        this.state.userProfile.id = this.state.userProfile.id || `mock_${Date.now()}`;
                    }
                } else {
                    this.log("Telegram WebApp script not loaded. Running in standalone mode.");
                     this.state.userProfile.id = this.state.userProfile.id || `standalone_${Date.now()}`;
                }
            } catch (error) {
                this.error("Error setting up Telegram WebApp:", error);
            }
        },
        
        applyTheme: function(themeParams) {
            this.log("Applying Telegram theme:", themeParams);
            const root = document.documentElement;
            if (themeParams.bg_color) root.style.setProperty('--tg-theme-bg-color', themeParams.bg_color);
            if (themeParams.text_color) root.style.setProperty('--tg-theme-text-color', themeParams.text_color);
            if (themeParams.hint_color) root.style.setProperty('--tg-theme-hint-color', themeParams.hint_color);
            if (themeParams.link_color) root.style.setProperty('--tg-theme-link-color', themeParams.link_color);
            if (themeParams.button_color) root.style.setProperty('--tg-theme-button-color', themeParams.button_color);
            if (themeParams.button_text_color) root.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color);
            if (themeParams.secondary_bg_color) root.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
        },

        cacheDOMElements: function() {
            this.log("Caching DOM elements...");
            this.elements = {
                appHeader: document.getElementById('app-header'),
                contentArea: document.querySelector('.content-area'),
                bottomNav: document.getElementById('bottom-nav'),
                navButtons: document.querySelectorAll('.nav-btn'),
                loadingOverlay: document.getElementById('loading-overlay'), // Crucial for hiding

                pages: document.querySelectorAll('.page'),
                pageTap: document.getElementById('page-tap'),
                pageProfile: document.getElementById('page-profile'),
                pageUpgrades: document.getElementById('page-upgrades'),
                pageTask: document.getElementById('page-task'),
                pageFrens: document.getElementById('page-frens'),
                pageBoosts: document.getElementById('page-boosts'),
                pageWithdraw: document.getElementById('page-withdraw'),

                pointsDisplay: document.getElementById('points-display'),
                pointsDisplayIcon: document.getElementById('points-display-icon'),
                tapButton: document.getElementById('tap-button'),
                tapButtonContainer: document.getElementById('tap-button-container'),
                tapImage: document.getElementById('tap-image'),
                energyText: document.getElementById('energy-text'),
                energyBarFill: document.getElementById('energy-bar-fill'),
                profitPerHourDisplay: document.getElementById('profit-per-hour-display'),
                levelDisplay: document.getElementById('level-display'),
                boostFullEnergyBtn: document.getElementById('boost-full-energy-btn'),
                fullEnergyBoostsLeftDisplay: document.getElementById('full-energy-boosts-left'),

                profileNameGreeting: document.getElementById('profile-name-greeting'),
                profileUserId: document.getElementById('profile-userId'),
                profilePoints: document.getElementById('profile-points'),
                profilePph: document.getElementById('profile-pph'),
                profileMaxEnergy: document.getElementById('profile-max-energy'),
                profileTapPower: document.getElementById('profile-tap-power'),
                profileJoinDate: document.getElementById('profile-join-date'),
                profileAvatar: document.getElementById('profile-avatar'),
                profileReferralLink: document.getElementById('profile-referral-link'),

                upgradesListContainer: document.getElementById('upgrades-list-container'),
                boostsListContainer: document.getElementById('boosts-list-container'),
                taskCategoriesContainer: document.getElementById('task-categories'),

                frensList: document.getElementById('frens-list'),
                frensCountDisplay: document.getElementById('frens-count'),
                noFrensMessage: document.getElementById('no-frens-message'),
                frenInviteBonusDisplay: document.getElementById('fren-invite-bonus'),
                frenWelcomeBonusDisplay: document.getElementById('fren-welcome-bonus'),

                withdrawAmountInput: document.getElementById('withdraw-amount'),
                withdrawMethodSelect: document.getElementById('withdraw-method'),
                withdrawAddressInput: document.getElementById('withdraw-address'),
                submitWithdrawBtn: document.getElementById('submit-withdraw-btn'),
                withdrawMessage: document.getElementById('withdraw-message'),
                withdrawHistoryList: document.getElementById('withdraw-history-list'),
                noWithdrawHistoryMessage: document.getElementById('no-withdraw-history'),

                dailyRewardModal: document.getElementById('daily-reward-modal'),
                dailyRewardMessage: document.getElementById('daily-reward-message'),
                dailyRewardAmount: document.getElementById('daily-reward-amount'),
                claimDailyRewardBtn: document.getElementById('claim-daily-reward-btn'),
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmationModalIcon: document.getElementById('confirmation-modal-icon'),
                confirmationModalTitle: document.getElementById('confirmation-modal-title'),
                confirmationModalMessage: document.getElementById('confirmation-modal-message'),
                confirmationModalCancelBtn: document.getElementById('confirmation-modal-cancel-btn'),
                confirmationModalConfirmBtn: document.getElementById('confirmation-modal-confirm-btn'),
                
                toastNotification: document.getElementById('toast-notification'),
            };
            this.log("DOM elements cached.");
            if (!this.elements.loadingOverlay) { // Check specifically for loadingOverlay after caching
                 this.error("Loading overlay NOT found in this.elements after caching.");
            }
        },

        bindEventListeners: function() {
            this.log("Binding event listeners...");
            this.elements.navButtons.forEach(btn => {
                btn.addEventListener('click', () => this.navigateToPage(btn.dataset.page));
            });

            if(this.elements.boostFullEnergyBtn) this.elements.boostFullEnergyBtn.addEventListener('click', () => this.activateFullEnergyBoost());
            if(this.elements.claimDailyRewardBtn) this.elements.claimDailyRewardBtn.addEventListener('click', () => this.claimDailyReward());
            if(this.elements.confirmationModalCancelBtn) this.elements.confirmationModalCancelBtn.addEventListener('click', () => this.hideConfirmationModal());

            [this.elements.dailyRewardModal, this.elements.confirmationModal].forEach(modal => {
                if (modal && modal.querySelector('.modal-content')) {
                    modal.querySelector('.modal-content').addEventListener('click', e => e.stopPropagation());
                    modal.addEventListener('click', () => {
                        if (modal.id === 'daily-reward-modal' && this.elements.claimDailyRewardBtn && this.elements.claimDailyRewardBtn.disabled) {
                            // No close
                        } else if (modal.id === 'confirmation-modal') {
                            this.hideConfirmationModal();
                        } else {
                             modal.classList.remove('show');
                        }
                    });
                }
            });

            if (this.elements.tapButton) {
                this.elements.tapButton.addEventListener('touchend', (event) => event.preventDefault(), { passive: false });
            }

            window.addEventListener('beforeunload', () => this.saveGameState());
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    this.saveGameState();
                } else if (document.visibilityState === 'visible') {
                    this.loadGameState();
                    this.lastEnergyUpdateTime = Date.now();
                    this.checkDailyReward();
                    this.checkDailyBoostReset();
                }
            });
            this.log("Event listeners bound.");
        },
        
        initializeGameData: function() {
            this.log("Initializing game data (upgrades, tasks, boosts)...");
            this.state.availableUpgrades = [
                { 
                    id: 'multitap', name: 'Multi-Tap Glove', category: 'Tap', icon: 'üëÜ',
                    description: 'Increases points earned per tap.',
                    baseCost: 50, costMultiplier: 1.8, baseEffect: 1, effectIncrement: 1, maxLevel: 20 
                },
                { 
                    id: 'energyLimit', name: 'Energy Cap', category: 'Energy', icon: 'üîã',
                    description: 'Increases your maximum energy.',
                    baseCost: 100, costMultiplier: 2.0, baseEffect: this.config.defaultEnergy, effectIncrement: 100, maxLevel: 15
                },
                { 
                    id: 'energyRecharge', name: 'Recharge Speed', category: 'Energy', icon: '‚ö°Ô∏è',
                    description: 'Increases energy recharge rate (per second).',
                    baseCost: 250, costMultiplier: 2.2, baseEffect: this.config.energyRechargeRate, effectIncrement: 1, maxLevel: 10
                },
                { 
                    id: 'profitPerHourPassive', name: 'Hourly Earnings', category: 'Passive', icon: '‚è∞',
                    description: 'Increases your passive profit per hour (PPH).',
                    baseCost: 1000, costMultiplier: 1.9, baseEffect: 0, effectIncrement: 100, maxLevel: 25
                },
                {
                    id: 'offlineBonus', name: 'Offline Bonus', category: 'Passive', icon: 'üí§',
                    description: 'Increases earnings while you are away.',
                    baseCost: 5000, costMultiplier: 2.5, baseEffect: this.config.offlineEarningsMultiplier, effectIncrement: 0.05, maxLevel: 10
                }
            ];

            this.state.availableTasks = [
                {
                    category: 'Daily Tasks',
                    tasks: [
                        { id: 'dailyLogin', name: 'Daily Check-in', icon: 'üìÖ', description: 'Log in daily for a bonus.', reward: 500, type: 'daily', actionText: 'Claimed', isCompleted: () => this.isDailyTaskCompleted('dailyLogin') },
                        { id: 'tap100', name: 'Tap 100 Times', icon: 'üñêÔ∏è', description: 'Perform 100 taps today.', reward: 250, type: 'daily_counter', target: 100, counterKey: 'dailyTaps', actionText: 'Go Tap!', checkCompletion: () => this.getDailyCounter('dailyTaps') >= 100 },
                    ]
                },
                {
                    category: 'Social Tasks',
                    tasks: [
                        { id: 'joinTelegram', name: 'Join Community', icon: 'üì¢', description: 'Join our Telegram channel.', reward: 1000, type: 'external', link: 'https://t.me/your_channel_link', actionText: 'Join', verification: 'manual' },
                        { id: 'inviteFren', name: 'Invite a Friend', icon: 'üßë‚Äçü§ù‚Äçüßë', description: 'Invite one friend to the game.', reward: 2000, type: 'game_event', eventKey: 'frenInvited', actionText: 'Invite', checkCompletion: () => this.state.frens.length > 0 },
                    ]
                },
                {
                    category: 'Special Tasks',
                    tasks: [
                        { id: 'reachLevel5', name: 'Reach Level 5', icon: '‚≠ê', description: 'Achieve player level 5.', reward: 5000, type: 'game_milestone', checkCompletion: () => this.state.level >= 5, actionText: 'In Progress' },
                        { id: 'firstUpgrade', name: 'First Upgrade', icon: 'üõ†Ô∏è', description: 'Buy your first upgrade.', reward: 300, type: 'game_milestone', checkCompletion: () => Object.keys(this.state.upgrades).length > 0, actionText: 'Upgrade!' },
                    ]
                }
            ];
            
            this.state.availableBoosts = [
                { 
                    id: 'fullEnergy', name: 'Full Energy Refill', icon: '‚õΩ',
                    description: `Instantly refills your energy bar. ${this.config.fullEnergyBoostsDaily} uses per day.`,
                    type: 'daily_limited', usesPerDay: this.config.fullEnergyBoostsDaily,
                    cost: 0,
                    action: () => this.activateFullEnergyBoost(true),
                    getUsesLeft: () => this.config.fullEnergyBoostsDaily - this.state.fullEnergyBoostsUsedToday,
                    buttonText: (usesLeft) => `Refill (${usesLeft})`
                },
                {
                    id: 'turboTap', name: 'Turbo Tap (x3)', icon: 'üöÄ',
                    description: 'Triples your tap power for 30 seconds. 1 use per day.',
                    type: 'daily_timed', duration: 30000,
                    cost: 0,
                    usesPerDay: 1,
                    action: () => this.activateTurboTapBoost(),
                    getUsesLeft: () => 1 - (this.state.activeBoosts && this.state.activeBoosts.turboTap && this.state.activeBoosts.turboTap.usedToday ? 1:0),
                    buttonText: (usesLeft) => usesLeft > 0 ? 'Activate' : 'Used'
                },
            ];
            
            this.state.availableUpgrades.forEach(upg => {
                if (this.state.upgrades[upg.id] === undefined) {
                    this.state.upgrades[upg.id] = 0;
                }
            });

            this.updateDerivedStats();
            this.log("Game data initialized.");
        },

        handleTap: function(event) {
            if (event.type === 'touchstart') event.preventDefault();
            if (event.type === 'mousedown' && event.button !== 0) return;
            
            if (this.state.currentEnergy >= this.config.energyPerTap) {
                this.state.currentEnergy -= this.config.energyPerTap;
                const pointsEarned = this.state.tapPower;
                this.state.points += pointsEarned;

                this.updatePointsDisplay();
                this.updateEnergyDisplay();
                this.animateTapScore(pointsEarned, event);
                if (this.state.settings.hapticsEnabled && window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
                this.incrementDailyCounter('dailyTaps');
            } else {
                this.showToast("Not enough energy!", "error");
                 if (this.state.settings.hapticsEnabled && window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
                }
            }
        },
        
        animateTapScore: function(score, event) {
            if (!this.elements.tapButtonContainer) return;
            const scoreText = document.createElement('div');
            scoreText.className = 'tap-score-animation';
            scoreText.textContent = `+${this.formatNumber(score)}`;
            this.elements.tapButtonContainer.appendChild(scoreText);

            const rect = this.elements.tapButtonContainer.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX; clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX; clientY = event.clientY;
            }
            const x = clientX - rect.left - (scoreText.offsetWidth / 2);
            const y = clientY - rect.top - (scoreText.offsetHeight / 2) - 20;
            scoreText.style.left = `${x + (Math.random() * 40 - 20)}px`;
            scoreText.style.top = `${y + (Math.random() * 20 - 10)}px`;
            setTimeout(() => scoreText.remove(), 1150);
        },

        startEnergyRechargeCycle: function() {
            setInterval(() => {
                const now = Date.now();
                const elapsedSeconds = Math.floor((now - this.state.lastEnergyUpdateTime) / 1000);
                if (elapsedSeconds > 0 && this.state.currentEnergy < this.state.maxEnergy) {
                    const energyToRecharge = elapsedSeconds * this.getUpgradeEffect('energyRecharge', this.config.energyRechargeRate);
                    this.state.currentEnergy = Math.min(this.state.maxEnergy, this.state.currentEnergy + energyToRecharge);
                    this.updateEnergyDisplay();
                }
                this.state.lastEnergyUpdateTime = now;
                this.saveGameState(); 
            }, 1000);
        },
        
        activateFullEnergyBoost: function(fromBoostPage = false) {
            if (this.state.fullEnergyBoostsUsedToday < this.config.fullEnergyBoostsDaily) {
                this.state.currentEnergy = this.state.maxEnergy;
                this.state.fullEnergyBoostsUsedToday++;
                this.updateEnergyDisplay();
                this.updateFullEnergyBoostButton();
                this.showToast("Energy refilled!", "success");
                if (this.state.settings.hapticsEnabled && window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
                if (fromBoostPage) this.renderBoostsPage();
            } else {
                this.showToast("No energy refills left today.", "error");
            }
        },

        calculateProfitPerHour: function() {
            this.state.profitPerHour = this.getUpgradeEffect('profitPerHourPassive', 0);
            return this.state.profitPerHour;
        },

        calculateOfflineEarnings: function() {
            const now = Date.now();
            const timeOfflineMs = now - this.state.lastLoginTime;
            const maxOfflineMs = this.config.maxOfflineHours * 3600000;
            const effectiveOfflineMs = Math.min(timeOfflineMs, maxOfflineMs);
            
            if (effectiveOfflineMs <= 60000) {
                this.state.lastLoginTime = now; this.saveGameState(); return;
            }
            const hoursOffline = effectiveOfflineMs / 3600000;
            const pph = this.state.profitPerHour > 0 ? this.state.profitPerHour : 10;
            const offlineMultiplier = this.getUpgradeEffect('offlineBonus', this.config.offlineEarningsMultiplier);
            const earnings = Math.floor(pph * hoursOffline * offlineMultiplier);

            if (earnings > 0) {
                this.state.points += earnings; this.updatePointsDisplay();
                this.showToast(`Welcome back! You earned ${this.formatNumber(earnings)} points while away.`, "info", 5000);
            }
            this.state.lastLoginTime = now; this.saveGameState();
        },

        getUpgradeCost: function(upgrade) {
            const level = this.state.upgrades[upgrade.id] || 0;
            if (level >= upgrade.maxLevel) return Infinity;
            return Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, level));
        },

        getUpgradeEffect: function(upgradeId, defaultValueIfNotFound = 0) {
            const upgrade = this.state.availableUpgrades.find(u => u.id === upgradeId);
            if (!upgrade) return defaultValueIfNotFound;
            const level = this.state.upgrades[upgradeId] || 0;
            let effect = upgrade.baseEffect;

            if (upgrade.id === 'multitap') {
                effect = this.config.pointsPerTap + (upgrade.effectIncrement * level);
            } else if (upgrade.id === 'energyLimit') {
                effect = this.config.defaultEnergy + (upgrade.effectIncrement * level);
            } else if (upgrade.id === 'energyRecharge') {
                 effect = this.config.energyRechargeRate + (upgrade.effectIncrement * level);
            } else if (level > 0) { // For PPH and OfflineBonus, effect starts from increment * level
                 effect = upgrade.effectIncrement * level;
                 if(upgrade.id === 'offlineBonus') effect = this.config.offlineEarningsMultiplier + (upgrade.effectIncrement * level); // Offline Bonus starts from config
            } else if(upgrade.id === 'offlineBonus' && level === 0){ // Base offline bonus if not upgraded
                effect = this.config.offlineEarningsMultiplier;
            } else if(level === 0){ // for PPH, if level 0, effect is baseEffect (which is 0)
                effect = upgrade.baseEffect;
            }
            return effect;
        },

        buyUpgrade: function(upgradeId) {
            const upgrade = this.state.availableUpgrades.find(u => u.id === upgradeId);
            if (!upgrade) { this.showToast("Upgrade not found!", "error"); return; }
            const cost = this.getUpgradeCost(upgrade);
            const currentLevel = this.state.upgrades[upgradeId] || 0;

            if (currentLevel >= upgrade.maxLevel) { this.showToast("Max level reached!", "info"); return; }
            if (this.state.points >= cost) {
                this.state.points -= cost; this.state.upgrades[upgradeId]++;
                this.updateDerivedStats(); this.updateAllUI(); this.renderUpgradesPage();
                this.showToast(`${upgrade.name} upgraded to Lvl ${this.state.upgrades[upgradeId]}!`, "success");
                if (this.state.settings.hapticsEnabled && window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                this.saveGameState();
            } else {
                this.showToast("Not enough points!", "error");
                if (this.state.settings.hapticsEnabled && window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
        },
        
        updateDerivedStats: function() {
            this.state.tapPower = this.getUpgradeEffect('multitap');
            this.state.maxEnergy = this.getUpgradeEffect('energyLimit');
            this.state.currentEnergy = Math.min(this.state.currentEnergy, this.state.maxEnergy);
            this.calculateProfitPerHour();
            this.updatePlayerLevel();
        },
        
        updatePlayerLevel: function() {
            const pph = this.state.profitPerHour;
            if (pph >= 10000) this.state.level = 5; else if (pph >= 5000) this.state.level = 4;
            else if (pph >= 1000) this.state.level = 3; else if (pph >= 100) this.state.level = 2;
            else this.state.level = 1;
        },

        completeTask: function(taskId) {
            const task = this.findTaskById(taskId);
            if (!task || this.state.tasksCompleted[taskId]) return;

            if (task.type === 'external' || task.type === 'daily' || (task.type === 'daily_counter' && task.checkCompletion && task.checkCompletion())) {
                this.state.points += task.reward; this.state.tasksCompleted[taskId] = true;
                if (task.type === 'daily') this.markDailyTaskCompleted(taskId);
                this.updatePointsDisplay(); this.renderTasksPage();
                this.showToast(`Task "${task.name}" complete! +${this.formatNumber(task.reward)}`, "success");
                this.saveGameState();
            } else if (task.link) {
                 if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.openLink(task.link);
                 else window.open(task.link, '_blank');
            }
        },

        findTaskById: function(taskId) {
            for (const category of this.state.availableTasks) {
                const task = category.tasks.find(t => t.id === taskId); if (task) return task;
            } return null;
        },
        isDailyTaskCompleted: function(taskId) {
            const today = new Date().toISOString().split('T')[0];
            return this.state.tasksCompleted[`${taskId}_${today}`] === true;
        },
        markDailyTaskCompleted: function(taskId) {
            const today = new Date().toISOString().split('T')[0];
            this.state.tasksCompleted[`${taskId}_${today}`] = true;
        },
        getDailyCounter: function(counterKey) {
            const today = new Date().toISOString().split('T')[0];
            return this.state.tasksCompleted[`${counterKey}_${today}_count`] || 0;
        },
        incrementDailyCounter: function(counterKey, amount = 1) {
            const today = new Date().toISOString().split('T')[0];
            const key = `${counterKey}_${today}_count`;
            this.state.tasksCompleted[key] = (this.state.tasksCompleted[key] || 0) + amount;
            this.checkCounterTaskCompletions(counterKey); this.saveGameState();
        },
        checkCounterTaskCompletions: function(counterKey) {
            this.state.availableTasks.forEach(cat => cat.tasks.forEach(task => {
                if (task.type === 'daily_counter' && task.counterKey === counterKey && !this.isTaskActuallyCompleted(task.id)) {
                    if (task.checkCompletion && task.checkCompletion() && this.state.currentPage === 'page-task') {
                        this.renderTasksPage();
                    }
                }
            }));
        },
        isTaskActuallyCompleted: function(taskId) {
            const task = this.findTaskById(taskId); if (!task) return false;
            if (task.type === 'daily' || task.type === 'daily_counter') return this.isDailyTaskCompleted(taskId);
            return this.state.tasksCompleted[taskId] === true;
        },
        
        checkDailyBoostReset: function() {
            const today = new Date().toISOString().split('T')[0];
            const lastReset = this.state.fullEnergyBoostsLastReset ? new Date(this.state.fullEnergyBoostsLastReset).toISOString().split('T')[0] : null;
            if (today !== lastReset) {
                this.state.fullEnergyBoostsUsedToday = 0;
                this.state.fullEnergyBoostsLastReset = Date.now();
                if(this.state.activeBoosts && this.state.activeBoosts.turboTap) this.state.activeBoosts.turboTap.usedToday = false;
                this.log("Daily boosts reset.");
                this.updateFullEnergyBoostButton();
                if(this.state.currentPage === 'page-boosts') this.renderBoostsPage();
                this.saveGameState();
            }
        },
        
        activateTurboTapBoost: function() {
            if (!this.state.activeBoosts) this.state.activeBoosts = {};
            if (!this.state.activeBoosts.turboTap) this.state.activeBoosts.turboTap = { active: false, endTime: 0, usedToday: false, originalTapPower: 0, usesCountToday: 0 };
            const boostState = this.state.activeBoosts.turboTap;
            const boostDef = this.state.availableBoosts.find(b => b.id === 'turboTap');
            if (boostState.active) { this.showToast("Turbo Tap active!", "info"); return; }
            if (boostState.usedToday && boostDef.usesPerDay <= boostState.usesCountToday) { this.showToast("Turbo Tap used today.", "info"); return; }

            boostState.originalTapPower = this.state.tapPower; this.state.tapPower *= 3;
            boostState.active = true; boostState.endTime = Date.now() + boostDef.duration;
            boostState.usedToday = true; boostState.usesCountToday++;
            this.showToast("Turbo Tap! Power x3 for 30s.", "success", 3000);
            this.updateTapPowerDisplay(); this.renderBoostsPage();
            setTimeout(() => {
                this.state.tapPower = boostState.originalTapPower; boostState.active = false;
                this.showToast("Turbo Tap ended.", "info");
                this.updateTapPowerDisplay(); this.renderBoostsPage(); this.saveGameState();
            }, boostDef.duration);
            this.saveGameState();
        },

        checkDailyReward: function() {
            const now = new Date(); const today = now.toISOString().split('T')[0];
            const lastClaim = this.state.dailyRewardClaimedTime ? new Date(this.state.dailyRewardClaimedTime).toISOString().split('T')[0] : null;
            if (today !== lastClaim) {
                if(this.elements.dailyRewardAmount) this.elements.dailyRewardAmount.textContent = this.formatNumber(this.config.dailyRewardBase);
                if(this.elements.claimDailyRewardBtn) this.elements.claimDailyRewardBtn.disabled = false;
                if(this.elements.dailyRewardModal) this.elements.dailyRewardModal.classList.add('show');
            }
        },
        claimDailyReward: function() {
            this.state.points += this.config.dailyRewardBase; this.state.dailyRewardClaimedTime = Date.now();
            this.updatePointsDisplay();
            if(this.elements.dailyRewardMessage) this.elements.dailyRewardMessage.textContent = `Awesome! ${this.formatNumber(this.config.dailyRewardBase)} points added.`;
            if(this.elements.claimDailyRewardBtn) { this.elements.claimDailyRewardBtn.textContent = "Claimed!"; this.elements.claimDailyRewardBtn.disabled = true; }
            this.showToast(`+${this.formatNumber(this.config.dailyRewardBase)} daily reward!`, "success");
            this.saveGameState();
            if(this.elements.dailyRewardModal) setTimeout(() => this.elements.dailyRewardModal.classList.remove('show'), 2000);
        },

        inviteFren: function() {
            const refId = this.state.userProfile.id || 'testuser'; const botName = "xotswap_bot";
            const refLink = `https://t.me/${botName}?start=ref_${refId}`;
            const text = `Join Xot_swap & get ${this.formatNumber(this.config.frenWelcomeBonus)} bonus! ${refLink}`;
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openTelegramLink) {
                 window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(refLink)}&text=${encodeURIComponent(`Join Xot_swap & get ${this.formatNumber(this.config.frenWelcomeBonus)} bonus!`)}`);
            } else { this.copyToClipboard(refLink, "Referral link copied!"); }
        },
        processReferral: function(referrerId) {
            this.log(`Referral from ${referrerId}`); this.state.points += this.config.frenWelcomeBonus;
            this.showToast(`Welcome! +${this.formatNumber(this.config.frenWelcomeBonus)} from your fren!`, "success", 4000);
            this.saveGameState();
        },
        addSimulatedFren: function() { /* For debug */
            const newFren = { id: `fren_${Date.now()}`, name: `Fren ${this.state.frens.length + 1}`, joinDate: new Date().toISOString(), pointsEarnedForMe: 0 };
            this.state.frens.push(newFren); this.state.points += this.config.frenInviteBonus;
            this.showToast(`${newFren.name} joined! +${this.formatNumber(this.config.frenInviteBonus)}`, "success");
            this.updatePointsDisplay(); this.renderFrensPage(); this.saveGameState();
            this.markTaskAsCompletedByEvent('frenInvited');
        },
        markTaskAsCompletedByEvent: function(eventKey) {
            this.state.availableTasks.forEach(cat => cat.tasks.forEach(task => {
                if (task.type === 'game_event' && task.eventKey === eventKey && !this.isTaskActuallyCompleted(task.id)) {
                    this.completeTask(task.id);
                }
            }));
        },

        handleWithdrawRequest: function() {
            const amount = parseInt(this.elements.withdrawAmountInput.value);
            const method = this.elements.withdrawMethodSelect.value;
            const address = this.elements.withdrawAddressInput.value;
            this.elements.withdrawMessage.textContent = ""; this.elements.withdrawMessage.className = "mt-2";

            if (isNaN(amount) || amount <= 0) { this.setWithdrawMessage("Enter valid amount.", "error"); return; }
            if (amount > this.state.points) { this.setWithdrawMessage("Insufficient points.", "error"); return; }
            if (method === "ton_usdt" && !address) { this.setWithdrawMessage("Enter TON wallet address.", "error"); return; }
            if (method === "ton_usdt" && (address.length < 40 || !address.startsWith("UQ") && !address.startsWith("EQ"))) {
                this.setWithdrawMessage("Invalid TON address.", "error"); return;
            }
            this.showLoadingOverlay(); this.setWithdrawMessage("Processing request...", "info");
            setTimeout(() => {
                this.hideLoadingOverlay(); const success = Math.random() > 0.1;
                if (success) {
                    this.state.points -= amount; this.updatePointsDisplay(); this.updateProfilePage();
                    this.setWithdrawMessage(`Withdrawal of ${this.formatNumber(amount)} submitted!`, "success");
                    const entry = { id: `wd_${Date.now()}`, amount, method, address, status: 'Pending', date: new Date().toISOString() };
                    if (!this.state.withdrawHistory) this.state.withdrawHistory = [];
                    this.state.withdrawHistory.unshift(entry); this.renderWithdrawHistory();
                    this.elements.withdrawAmountInput.value = ""; this.elements.withdrawAddressInput.value = "";
                    this.saveGameState();
                } else { this.setWithdrawMessage("Withdrawal failed. Try again later.", "error"); }
            }, 2000);
        },
        setWithdrawMessage: function(message, type) {
            if(this.elements.withdrawMessage) {
                 this.elements.withdrawMessage.textContent = message;
                 this.elements.withdrawMessage.className = `mt-2 ${type}`;
            }
        },

        updateAllUI: function() {
            this.log("Updating all UI components...");
            this.updatePointsDisplay(); this.updateEnergyDisplay(); this.updatePPHDisplay();
            this.updateLevelDisplay(); this.updateProfilePage(); this.updateTapPowerDisplay();
            this.updateMaxEnergyDisplay(); this.updateFullEnergyBoostButton();
            if (this.elements[this.state.currentPage]) {
                 switch(this.state.currentPage) {
                    case 'page-upgrades': this.renderUpgradesPage(); break;
                    case 'page-task': this.renderTasksPage(); break;
                    case 'page-frens': this.renderFrensPage(); break;
                    case 'page-boosts': this.renderBoostsPage(); break;
                 }
            }
        },
        updatePointsDisplay: function() {
            if (this.elements.pointsDisplay) this.elements.pointsDisplay.textContent = this.formatNumber(this.state.points);
            if (this.elements.profilePoints) this.elements.profilePoints.textContent = this.formatNumber(this.state.points);
        },
        updateEnergyDisplay: function() {
            if (this.elements.energyText && this.elements.energyBarFill) {
                this.elements.energyText.textContent = `${this.formatNumber(Math.floor(this.state.currentEnergy))}/${this.formatNumber(this.state.maxEnergy)}`;
                const perc = (this.state.maxEnergy > 0 ? (this.state.currentEnergy / this.state.maxEnergy) : 0) * 100;
                this.elements.energyBarFill.style.width = `${Math.max(0, Math.min(100, perc))}%`;
            }
        },
        updatePPHDisplay: function() {
            const pph = this.state.profitPerHour;
            if (this.elements.profitPerHourDisplay) this.elements.profitPerHourDisplay.textContent = `PPH: ${this.formatNumber(pph)}`;
            if (this.elements.profilePph) this.elements.profilePph.textContent = this.formatNumber(pph);
        },
        updateLevelDisplay: function() {
            if (this.elements.levelDisplay) this.elements.levelDisplay.textContent = `Level: ${this.state.level}`;
        },
        updateTapPowerDisplay: function() {
            if (this.elements.profileTapPower) this.elements.profileTapPower.textContent = this.formatNumber(this.state.tapPower);
        },
        updateMaxEnergyDisplay: function() {
            if (this.elements.profileMaxEnergy) this.elements.profileMaxEnergy.textContent = this.formatNumber(this.state.maxEnergy);
        },
        updateFullEnergyBoostButton: function() {
            if (this.elements.boostFullEnergyBtn && this.elements.fullEnergyBoostsLeftDisplay) {
                const left = this.config.fullEnergyBoostsDaily - this.state.fullEnergyBoostsUsedToday;
                this.elements.fullEnergyBoostsLeftDisplay.textContent = left;
                this.elements.boostFullEnergyBtn.disabled = left <= 0;
            }
        },
        renderProfilePage: function() {
            this.log("Rendering Profile Page...");
            if (this.elements.profileNameGreeting) this.elements.profileNameGreeting.textContent = `Welcome, ${this.state.userProfile.firstName || 'Player'}!`;
            if (this.elements.profileUserId) this.elements.profileUserId.textContent = this.state.userProfile.id || 'N/A';
            if (this.elements.profileJoinDate) this.elements.profileJoinDate.textContent = this.state.userProfile.joinDate ? new Date(this.state.userProfile.joinDate).toLocaleDateString() : 'N/A';
            if (this.elements.profileAvatar) {
                if (this.state.userProfile.photoUrl) this.elements.profileAvatar.innerHTML = `<img src="${this.state.userProfile.photoUrl}" alt="Avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                else this.elements.profileAvatar.textContent = (this.state.userProfile.firstName ? this.state.userProfile.firstName.charAt(0) : 'P').toUpperCase();
            }
            if (this.elements.frenInviteBonusDisplay) this.elements.frenInviteBonusDisplay.textContent = this.formatNumber(this.config.frenInviteBonus);
            if (this.elements.frenWelcomeBonusDisplay) this.elements.frenWelcomeBonusDisplay.textContent = this.formatNumber(this.config.frenWelcomeBonus);
            this.updatePointsDisplay(); this.updatePPHDisplay(); this.updateTapPowerDisplay(); this.updateMaxEnergyDisplay();
        },
        renderUpgradesPage: function() {
            this.log("Rendering Upgrades Page...");
            if (!this.elements.upgradesListContainer) return;
            this.elements.upgradesListContainer.innerHTML = '';
            const categories = {};
            this.state.availableUpgrades.forEach(upg => { if(!categories[upg.category]) categories[upg.category] = []; categories[upg.category].push(upg); });
            for (const catName in categories) {
                const catDiv = document.createElement('div'); catDiv.className = 'upgrade-category card';
                catDiv.innerHTML = `<div class="card-header"><h3>${catName} Upgrades</h3></div>`;
                const listDiv = document.createElement('div');
                categories[catName].forEach(upg => {
                    const lvl = this.state.upgrades[upg.id] || 0; const cost = this.getUpgradeCost(upg);
                    const effect = this.getUpgradeEffect(upg.id); const maxLvl = lvl >= upg.maxLevel;
                    let effTxt = '';
                    if (upg.id === 'multitap') effTxt = `+${this.formatNumber(effect)}/tap`;
                    else if (upg.id === 'energyLimit') effTxt = `Max ${this.formatNumber(effect)} energy`;
                    else if (upg.id === 'energyRecharge') effTxt = `+${this.formatNumber(effect)}/sec`;
                    else if (upg.id === 'profitPerHourPassive') effTxt = `+${this.formatNumber(effect)} PPH`;
                    else if (upg.id === 'offlineBonus') effTxt = `${(effect * 100).toFixed(0)}% offline`;
                    else effTxt = `Val: ${this.formatNumber(effect)}`;
                    const item = document.createElement('div'); item.className = 'list-item upgrade-item';
                    item.innerHTML = `<div class="list-item-icon">${upg.icon||'‚öôÔ∏è'}</div>
                        <div class="item-info"><div class="item-name">${upg.name}</div><div class="item-description">${upg.description}</div><div class="current-effect">${effTxt}</div></div>
                        <div class="item-action"><span class="level">Lvl: ${lvl}/${upg.maxLevel}</span>
                        ${!maxLvl ? `<span class="cost">Cost: ${this.formatNumber(cost)}üí∞</span>` : ''}
                        <button class="primary-btn buy-upgrade-btn" data-upgrade-id="${upg.id}" ${maxLvl||this.state.points<cost?'disabled':''}>${maxLvl?'Max': 'Upgrade'}</button></div>`;
                    listDiv.appendChild(item);
                });
                catDiv.appendChild(listDiv); this.elements.upgradesListContainer.appendChild(catDiv);
            }
            this.elements.upgradesListContainer.querySelectorAll('.buy-upgrade-btn').forEach(btn => btn.addEventListener('click', (e) => this.buyUpgrade(e.currentTarget.dataset.upgradeId)));
        },
        renderTasksPage: function() {
            this.log("Rendering Tasks Page...");
            if (!this.elements.taskCategoriesContainer) return;
            this.elements.taskCategoriesContainer.innerHTML = '';
            this.state.availableTasks.forEach(catData => {
                const catCard = document.createElement('div'); catCard.className = 'card task-category';
                catCard.innerHTML = `<div class="card-header"><h3>${catData.category}</h3></div>`;
                const ul = document.createElement('ul'); ul.className = 'task-list list-unstyled';
                if (catData.tasks.length === 0) ul.innerHTML = `<li class="text-hint text-center p-2">No tasks here.</li>`;
                else catData.tasks.forEach(task => {
                    const completed = this.isTaskActuallyCompleted(task.id); let canClaim = false; let progTxt = '';
                    if (task.type === 'daily_counter' && !completed) {
                        const count = this.getDailyCounter(task.counterKey); progTxt = `(${count}/${task.target})`;
                        if (task.checkCompletion && task.checkCompletion()) canClaim = true;
                    } else if ((task.type === 'game_milestone' || task.type === 'external' || task.type === 'daily') && !completed) {
                        canClaim = (task.checkCompletion && task.checkCompletion()) || (task.type === 'external' || task.type === 'daily');
                    }
                    const li = document.createElement('li'); li.className = `list-item task-item ${completed ? 'completed':''}`;
                    li.innerHTML = `<div class="list-item-icon">${task.icon||'‚úîÔ∏è'}</div>
                        <div class="item-info"><div class="item-name">${task.name} ${progTxt}</div><div class="item-description">${task.description}</div><div class="item-reward">Reward: ${this.formatNumber(task.reward)}üí∞</div></div>
                        <div class="item-action task-action"><button class="primary-btn complete-task-btn" data-task-id="${task.id}" ${completed?'disabled':(!canClaim && (task.type!=='external'&&task.type!=='game_event')?'disabled':'')}>
                        ${completed?'Claimed':(((task.type==='daily_counter'||task.type==='game_milestone')&&!canClaim)?task.actionText:(task.link?'Go':'Claim'))}</button></div>`;
                    ul.appendChild(li);
                });
                catCard.appendChild(ul); this.elements.taskCategoriesContainer.appendChild(catCard);
            });
            this.elements.taskCategoriesContainer.querySelectorAll('.complete-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId; const task = this.findTaskById(taskId);
                if (task && task.link && !this.isTaskActuallyCompleted(taskId)) {
                    if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.openLink(task.link); else window.open(task.link, '_blank');
                    if(task.type !== 'external') e.currentTarget.textContent = 'Check'; else this.completeTask(taskId);
                } else this.completeTask(taskId);
            }));
        },
        renderFrensPage: function() {
            this.log("Rendering Frens Page...");
            if (!this.elements.frensList) return;
            this.elements.frensList.innerHTML = '';
            if (this.elements.frensCountDisplay) this.elements.frensCountDisplay.textContent = this.state.frens.length;
            if (this.elements.frenInviteBonusDisplay) this.elements.frenInviteBonusDisplay.textContent = this.formatNumber(this.config.frenInviteBonus);
            if (this.elements.frenWelcomeBonusDisplay) this.elements.frenWelcomeBonusDisplay.textContent = this.formatNumber(this.config.frenWelcomeBonus);
            if (this.state.frens.length === 0) { this.elements.noFrensMessage.classList.remove('hidden'); return; }
            this.elements.noFrensMessage.classList.add('hidden');
            this.state.frens.forEach(fren => {
                const li = document.createElement('li'); li.className = 'list-item fren-item';
                const initial = fren.name ? fren.name.charAt(0).toUpperCase() : 'F';
                li.innerHTML = `<div class="list-item-icon fren-avatar" style="${fren.photoUrl?`background-image:url(${fren.photoUrl})`:''}">${fren.photoUrl?'':initial}</div>
                    <div class="item-info"><div class="item-name fren-name">${fren.name||'Anon Fren'}</div><div class="item-description">Joined: ${new Date(fren.joinDate).toLocaleDateString()}</div></div>
                    <div class="item-action"><span class="fren-bonus">+${this.formatNumber(fren.pointsEarnedForMe||0)}</span></div>`;
                this.elements.frensList.appendChild(li);
            });
            if (this.state.frens.length === 0 && this.config.debugMode) { /* For debug */
                const btn = document.createElement('button'); btn.textContent="Add Sim Fren"; btn.className="primary-btn mt-2"; btn.onclick=()=>this.addSimulatedFren();
                this.elements.frensList.parentNode.appendChild(btn);
            }
        },
        renderBoostsPage: function() {
            this.log("Rendering Boosts Page...");
            if (!this.elements.boostsListContainer) return;
            this.elements.boostsListContainer.innerHTML = '';
            this.state.availableBoosts.forEach(boost => {
                const item = document.createElement('div'); item.className = 'list-item boost-item';
                let usesLeft = Infinity, btnTxt = 'Activate', disabled = false, timerTxt = '';
                if (boost.type === 'daily_limited' || boost.type === 'daily_timed') {
                    usesLeft = boost.getUsesLeft ? boost.getUsesLeft() : (boost.usesPerDay - (this.state.activeBoosts && this.state.activeBoosts[boost.id] && this.state.activeBoosts[boost.id].usesCountToday || 0));
                    btnTxt = boost.buttonText ? boost.buttonText(usesLeft) : (usesLeft > 0 ? `Activate (${usesLeft})` : 'Used');
                    if (usesLeft <= 0) disabled = true;
                }
                if (boost.type === 'daily_timed' && this.state.activeBoosts && this.state.activeBoosts[boost.id] && this.state.activeBoosts[boost.id].active) {
                    const timeLeft = Math.max(0, Math.round((this.state.activeBoosts[boost.id].endTime - Date.now())/1000));
                    timerTxt = `<div class="boost-timer">Active: ${timeLeft}s</div>`; btnTxt = 'Active'; disabled = true; item.classList.add('active');
                }
                item.innerHTML = `<div class="list-item-icon">${boost.icon||'üî•'}</div>
                    <div class="item-info"><div class="item-name">${boost.name}</div><div class="item-description">${boost.description}</div>${timerTxt}
                    ${boost.cost>0?`<div class="item-reward">Cost: ${this.formatNumber(boost.cost)}üí∞</div>`:''}</div>
                    <div class="item-action"><button class="primary-btn activate-boost-btn" data-boost-id="${boost.id}" ${disabled||(boost.cost>0&&this.state.points<boost.cost)?'disabled':''}>${btnTxt}</button></div>`;
                this.elements.boostsListContainer.appendChild(item);
            });
            this.elements.boostsListContainer.querySelectorAll('.activate-boost-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const bId = e.currentTarget.dataset.boostId; const b = this.state.availableBoosts.find(x=>x.id===bId);
                if (b&&b.action) { if(b.cost>0&&this.state.points<b.cost){this.showToast("Not enough points!","error");return;} if(b.cost>0)this.state.points-=b.cost;this.updatePointsDisplay();b.action(); }
                else this.showToast("Boost NA.", "error");
            }));
        },
        renderWithdrawHistory: function() {
            if (!this.elements.withdrawHistoryList) return;
            this.elements.withdrawHistoryList.innerHTML = '';
            const hist = this.state.withdrawHistory || [];
            if (hist.length === 0) { this.elements.noWithdrawHistoryMessage.classList.remove('hidden'); return; }
            this.elements.noWithdrawHistoryMessage.classList.add('hidden');
            hist.forEach(item => {
                const li = document.createElement('li'); li.className = 'history-item';
                li.innerHTML = `<div><span class="amount">${this.formatNumber(item.amount)} Pts</span> to ${item.method.replace('_',' ').toUpperCase()}<br><small class="text-hint">Date: ${new Date(item.date).toLocaleString()}</small></div>
                    <div class="status ${item.status.toLowerCase()}">${item.status}</div>`;
                this.elements.withdrawHistoryList.appendChild(li);
            });
        },

        navigateToPage: function(pageId, isInitialLoad = false) {
            this.log(`Navigating to: ${pageId}`);
            if (!this.elements[pageId]) { this.error(`Page ${pageId} NA.`); if(pageId!=='page-tap') this.navigateToPage('page-tap'); return; }
            const oldPage = document.querySelector('.page.active');
            if (oldPage && !isInitialLoad) { oldPage.classList.add('exiting'); setTimeout(() => { oldPage.classList.remove('active','exiting');},300); }
            else if (oldPage) oldPage.classList.remove('active');
            const newPage = this.elements[pageId];
            setTimeout(() => newPage.classList.add('active'), isInitialLoad ? 0 : 50);
            this.state.currentPage = pageId;
            this.elements.navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
            switch(pageId) {
                case 'page-profile': this.renderProfilePage(); break; case 'page-upgrades': this.renderUpgradesPage(); break;
                case 'page-task': this.renderTasksPage(); break; case 'page-frens': this.renderFrensPage(); break;
                case 'page-boosts': this.renderBoostsPage(); break; case 'page-withdraw': this.renderWithdrawHistory(); break;
            }
            if (this.elements.contentArea) this.elements.contentArea.scrollTop = 0;
            if(!isInitialLoad) this.saveGameState();
        },

        showToast: function(message, type = 'info', duration = 3000) {
            if (!this.elements.toastNotification) return;
            const toast = this.elements.toastNotification;
            toast.textContent = message; toast.className = `show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace('show','').trim(); }, duration);
        },
        showConfirmationModal: function(title, message, onConfirm, icon = '‚ùì') {
            if (!this.elements.confirmationModal) return;
            this.elements.confirmationModalTitle.textContent = title;
            this.elements.confirmationModalMessage.innerHTML = message;
            this.elements.confirmationModalIcon.textContent = icon;
            const oldConfirm = this.elements.confirmationModalConfirmBtn;
            const newConfirm = oldConfirm.cloneNode(true);
            oldConfirm.parentNode.replaceChild(newConfirm, oldConfirm);
            this.elements.confirmationModalConfirmBtn = newConfirm;
            this.elements.confirmationModalConfirmBtn.onclick = () => { onConfirm(); this.hideConfirmationModal(); };
            this.elements.confirmationModal.classList.add('show');
        },
        hideConfirmationModal: function() { if (this.elements.confirmationModal) this.elements.confirmationModal.classList.remove('show'); },
        showLoadingOverlay: function() { if (this.elements.loadingOverlay) this.elements.loadingOverlay.classList.add('show'); else console.error("Attempted to show loading overlay, but element not found/cached."); },
        hideLoadingOverlay: function() { if (this.elements.loadingOverlay) { this.elements.loadingOverlay.classList.remove('show'); this.log("Loading overlay hidden.");} else this.error("Attempted to hide loading overlay, but element not found/cached."); },

        saveGameState: function() {
            try {
                const stateToSave = { points:this.state.points, level:this.state.level, currentEnergy:this.state.currentEnergy, lastEnergyUpdateTime:this.state.lastEnergyUpdateTime,
                    lastLoginTime:this.state.lastLoginTime, dailyRewardClaimedTime:this.state.dailyRewardClaimedTime, fullEnergyBoostsUsedToday:this.state.fullEnergyBoostsUsedToday,
                    fullEnergyBoostsLastReset:this.state.fullEnergyBoostsLastReset, upgrades:this.state.upgrades, tasksCompleted:this.state.tasksCompleted, frens:this.state.frens,
                    userProfileId:this.state.userProfile.id, userProfileJoinDate:this.state.userProfile.joinDate, settings:this.state.settings, currentPage:this.state.currentPage,
                    activeBoosts:this.state.activeBoosts, withdrawHistory:this.state.withdrawHistory, };
                localStorage.setItem(this.config.localStoragePrefix + 'gameState', JSON.stringify(stateToSave));
                this.log("Game state saved.");
            } catch (e) { this.error("Error saving game state:", e); }
        },
        loadGameState: function() {
            this.log("Loading game state...");
            try {
                const saved = localStorage.getItem(this.config.localStoragePrefix + 'gameState');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.state.points = parsed.points||0; this.state.level = parsed.level||1;
                    this.state.currentEnergy = parsed.currentEnergy !== undefined ? parsed.currentEnergy : this.config.defaultEnergy;
                    this.state.lastEnergyUpdateTime = parsed.lastEnergyUpdateTime||Date.now(); this.state.lastLoginTime = parsed.lastLoginTime||Date.now();
                    this.state.dailyRewardClaimedTime = parsed.dailyRewardClaimedTime||0; this.state.fullEnergyBoostsUsedToday = parsed.fullEnergyBoostsUsedToday||0;
                    this.state.fullEnergyBoostsLastReset = parsed.fullEnergyBoostsLastReset||0; this.state.upgrades = parsed.upgrades||{};
                    this.state.tasksCompleted = parsed.tasksCompleted||{}; this.state.frens = parsed.frens||[];
                    this.state.settings = {...this.state.settings, ...parsed.settings}; this.state.currentPage = parsed.currentPage||'page-tap';
                    this.state.activeBoosts = parsed.activeBoosts||{}; this.state.withdrawHistory = parsed.withdrawHistory||[];
                    if (parsed.userProfileId && !this.state.userProfile.id) this.state.userProfile.id = parsed.userProfileId;
                    if (parsed.userProfileJoinDate) this.state.userProfile.joinDate = parsed.userProfileJoinDate;
                    this.log("Game state loaded.");
                } else {
                    this.log("No saved state. Init with defaults.");
                    this.updateDerivedStats(); this.state.currentEnergy = this.state.maxEnergy;
                    this.state.lastLoginTime = Date.now(); this.state.userProfile.joinDate = new Date().toISOString();
                    this.saveGameState();
                }
            } catch (e) { this.error("Error loading game state:", e); }
            this.updateDerivedStats();
            this.state.currentEnergy = Math.min(this.state.currentEnergy, this.state.maxEnergy);
        },
        resetGameState: function(confirm = true) {
            const doReset = () => {
                localStorage.removeItem(this.config.localStoragePrefix + 'gameState');
                const tgUser = {...this.state.userProfile};
                Object.assign(this.state, { points:0,level:1,maxEnergy:this.config.defaultEnergy,currentEnergy:this.config.defaultEnergy,tapPower:this.config.pointsPerTap,
                    profitPerHour:0,lastEnergyUpdateTime:Date.now(),lastLoginTime:Date.now(),dailyRewardClaimedTime:0,fullEnergyBoostsUsedToday:0,fullEnergyBoostsLastReset:0,
                    upgrades:{},tasksCompleted:{},frens:[],activeBoosts:{},withdrawHistory:[] });
                this.state.userProfile = tgUser; if (!this.state.userProfile.joinDate) this.state.userProfile.joinDate = new Date().toISOString();
                this.initializeGameData(); this.updateAllUI(); this.saveGameState();
                this.showToast("Game Reset!", "success"); this.log("Game state reset."); this.navigateToPage('page-tap');
            };
            if (confirm) this.showConfirmationModal("Reset Game?", "Sure? This cannot be undone.", doReset, "‚ö†Ô∏è");
            else doReset();
        },

        formatNumber: function(num) {
            if (num === undefined || num === null) return '0';
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 10000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toLocaleString('en-US');
        },
        copyToClipboard: function(text, msg = "Copied!") {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => this.showToast(msg, "success")).catch(() => this.showToast("Copy failed.", "error"));
            } else {
                const ta = document.createElement("textarea"); ta.value=text; ta.style.position="fixed"; document.body.appendChild(ta);
                ta.focus(); ta.select(); try { document.execCommand('copy'); this.showToast(msg, "success"); }
                catch (err) { this.showToast("Copy failed (fallback).", "error"); } document.body.removeChild(ta);
            }
        },
        copyReferralLink: function() {
            const refId = this.state.userProfile.id || 'testuser'; const botName = "xotswap_bot";
            const refLink = `https://t.me/${botName}?start=ref_${refId}`;
            this.copyToClipboard(refLink, "Referral link copied!");
        },
        log: function(...args) { if (this.config.debugMode) console.log(`[${this.config.appName}]`, ...args); },
        error: function(...args) { console.error(`[${this.config.appName} ERROR]`, ...args); }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const loadingOverlayElem = document.getElementById('loading-overlay');
        if (loadingOverlayElem) {
            loadingOverlayElem.classList.add('show');
            // Use a direct console.log here as app.log might not be ready if debugMode is false
            if(app.config.debugMode) console.log("[Xot_swap Power Play] Loading overlay shown by DOMContentLoaded.");
        } else {
            console.error("[Xot_swap Power Play FATAL] loading-overlay element NOT FOUND by DOMContentLoaded.");
        }
        app.init();
    });

    if (app.config.debugMode) { // This check needs to be outside the main IIFE or class if app is not global yet
        window.xotApp = app; // Expose app for debugging
    }
    </script>
</body>
</html>
```
