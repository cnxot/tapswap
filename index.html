<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Xot_swap</title>
    <style>
        :root {
            --primary-color: #28a745; /* Greenish */
            --secondary-color: #17a2b8; /* Bluish */
            --background-color: #f4f4f9; /* Light grey */
            --card-background: #ffffff;
            --text-color: #333333;
            --nav-background: #ffffff;
            --nav-text-color: #555555;
            --nav-active-color: var(--primary-color);
            --button-color: var(--primary-color);
            --button-text-color: #ffffff;
            --energy-bar-background: #e9ecef;
            --energy-bar-fill: #ffc107; /* Yellow for energy */
            --points-color: var(--primary-color);
            --header-height: 50px;
            --nav-height: 60px;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, pages will scroll if needed */
        }

        #app-header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 15px 0;
            font-size: 1.2em;
            font-weight: bold;
            height: var(--header-height);
            line-height: calc(var(--header-height) - 30px); /* vertical align text */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .content-area {
            flex-grow: 1;
            padding-top: var(--header-height); /* Space for fixed header */
            padding-bottom: var(--nav-height); /* Space for fixed nav */
            overflow-y: auto; /* Allow scrolling within content area */
        }

        .page {
            display: none;
            padding: 20px;
            min-height: calc(100vh - var(--header-height) - var(--nav-height) - 40px); /* Full viewport minus headers/padding */
        }

        .page.active {
            display: block;
        }

        /* Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--nav-background);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--nav-text-color);
            font-size: 10px; /* Smaller text for icons + text */
            cursor: pointer;
            padding: 5px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .nav-btn svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .nav-btn.active {
            color: var(--nav-active-color);
            font-weight: bold;
        }
        
        .nav-btn.active svg path {
            fill: var(--nav-active-color);
        }

        /* Tap Page */
        #page-tap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #points-display {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--points-color);
            margin-bottom: 20px;
        }

        #tap-button {
            width: 200px; /* Adjust size as needed */
            height: 200px; /* Adjust size as needed */
            cursor: pointer;
            border-radius: 50%; /* Make it round if you want a circular tap area */
            /* background-color: #ddd; Remove if image fills it */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            user-select: none; /* Prevent text selection on rapid taps */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transition: transform 0.05s ease-out; /* Tap feedback */
        }
        #tap-button:active {
            transform: scale(0.95);
        }

        #tap-image { /* This is the cat/hamster image */
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensures image fits well */
        }

        #energy-container {
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        #energy-bar-bg {
            background-color: var(--energy-bar-background);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        #energy-bar-fill {
            background-color: var(--energy-bar-fill);
            width: 100%; /* Controlled by JS */
            height: 100%;
            border-radius: 10px;
            transition: width 0.2s ease-in-out;
        }
        
        #energy-text {
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Profile Page */
        #page-profile .profile-item {
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #page-profile .profile-item strong {
            color: var(--primary-color);
        }

        /* Task Page */
        .task-list {
            list-style: none;
            padding: 0;
        }
        .task-item {
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-item .task-info {
            flex-grow: 1;
        }
        .task-item .task-name {
            font-weight: bold;
        }
        .task-item .task-reward {
            font-size: 0.9em;
            color: #555;
        }
        .task-item .task-action button {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .task-item .task-action button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Withdraw Page */
        #page-withdraw .form-group {
            margin-bottom: 15px;
        }
        #page-withdraw label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #page-withdraw input[type="number"],
        #page-withdraw select {
            width: calc(100% - 22px); /* Full width minus padding/border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        #page-withdraw button {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
        }
        #page-withdraw button:disabled {
            background-color: #ccc;
        }
        #withdraw-history {
            margin-top: 20px;
        }
        #withdraw-history h3 {
            margin-bottom: 10px;
        }
        .history-item {
            background-color: var(--card-background);
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* General utility */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px_4px rgba(0,0,0,0.1);
        }
        .text-center {
            text-align: center;
        }

        /* Floating tap score animation */
        .tap-score-animation {
            position: absolute;
            font-size: 1.5em; /* Adjust as needed */
            color: var(--primary-color); /* Or gold, etc. */
            font-weight: bold;
            user-select: none;
            pointer-events: none;
            animation: floatUpAndFade 1s forwards;
            z-index: 100; /* Above the tap button */
        }

        @keyframes floatUpAndFade {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px); /* Adjust vertical distance */
            }
        }

    </style>
</head>
<body>
    <div id="app-header">Xot_swap</div>

    <div class="content-area">
        <!-- Profile Page -->
        <div id="page-profile" class="page">
            <h2>Profile</h2>
            <div class="card">
                <div class="profile-item"><strong>Name:</strong> <span id="profile-name"></span></div>
                <div class="profile-item"><strong>Current Points:</strong> <span id="profile-points"></span></div>
                <div class="profile-item"><strong>Joined:</strong> <span id="profile-join-date"></span></div>
                <div class="profile-item"><strong>Referral Link:</strong> <br><span id="profile-referral-link" style="word-break: break-all;"></span></div>
            </div>
            <div class="text-center" style="margin-top: 20px;">
                <p>Bot: <a href="https://t.me/xotswap_bot" target="_blank">t.me/xotswap_bot</a></p>
                <p>Direct WebApp: <a href="http://t.me/xotswap_bot/Xot" target="_blank">t.me/xotswap_bot/Xot</a></p>
            </div>
        </div>

        <!-- Tap Page -->
        <div id="page-tap" class="page active">
            <div id="points-display">0</div>
            <div id="tap-button-container" style="position: relative;"> <!-- Container for tap button and animations -->
                <div id="tap-button">
                    <!-- 
                        Replace this SVG with your desired image.
                        For a raster image (PNG, JPG, GIF):
                        <img id="tap-image" src="YOUR_IMAGE_URL_HERE" alt="Tap Me">
                        Make sure the image is HD and fits well.
                    -->
                    <svg id="tap-image" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- Simple Cat SVG - Replace with Hamster or other image -->
                        <path d="M50 10 C 20 10, 20 40, 20 50 C 20 80, 30 90, 50 90 C 70 90, 80 80, 80 50 C 80 40, 80 10, 50 10 Z M 40 40 Q 45 35, 50 40 Q 55 35, 60 40 Q 55 45, 50 50 Q 45 45, 40 40 Z M 30 60 Q 50 70, 70 60 Q 50 80, 30 60 Z" fill="#FFA500"/>
                        <circle cx="35" cy="30" r="5" fill="black"/>
                        <circle cx="65" cy="30" r="5" fill="black"/>
                        <path d="M45 55 Q50 60 55 55" stroke="black" stroke-width="2" fill="none"/>
                        <path d="M20 50 A 10 10 0 0 0 10 40 L 10 30 A 5 5 0 0 1 20 30 Z" fill="#FFA500"/>
                        <path d="M80 50 A 10 10 0 0 1 90 40 L 90 30 A 5 5 0 0 0 80 30 Z" fill="#FFA500"/>
                    </svg>
                </div>
            </div>
            <div id="energy-container">
                <span>Energy: <span id="energy-text">100/100</span></span>
                <div id="energy-bar-bg">
                    <div id="energy-bar-fill"></div>
                </div>
            </div>
        </div>

        <!-- Task Page -->
        <div id="page-task" class="page">
            <h2>Tasks</h2>
            <ul id="task-list" class="task-list">
                <!-- Tasks will be rendered here by JS -->
            </ul>
        </div>

        <!-- Withdraw Page -->
        <div id="page-withdraw" class="page">
            <h2>Withdraw Points</h2>
            <div class="card">
                <div class="form-group">
                    <label for="withdraw-amount">Amount to Withdraw:</label>
                    <input type="number" id="withdraw-amount" placeholder="Enter points">
                </div>
                <div class="form-group">
                    <label for="withdraw-method">Withdrawal Method:</label>
                    <select id="withdraw-method">
                        <option value="paypal">PayPal</option>
                        <option value="bank">Wire Transfer</option>
                        <option value="crypto">Crypto (USDT)</option>
                    </select>
                </div>
                <button id="withdraw-btn">Withdraw</button>
                <p id="withdraw-message" style="margin-top:10px; text-align:center;"></p>
            </div>
            <div id="withdraw-history" class="card">
                <h3>Withdrawal History (Mock)</h3>
                <ul id="history-list" style="list-style:none; padding:0;">
                    <!-- History items will be added here -->
                </ul>
            </div>
        </div>
    </div>

    <nav id="bottom-nav">
        <button class="nav-btn" data-page="page-profile">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,5A3,3 0 0,1 15,8A3,3 0 0,1 12,11A3,3 0 0,1 9,8A3,3 0 0,1 12,5M12,19.2C9.5,19.2 7.29,17.92 6,15.98C6.03,13.98 10,12.9 12,12.9C14,12.9 17.97,13.98 18,15.98C16.71,17.92 14.5,19.2 12,19.2Z" /></svg>
            Profile
        </button>
        <button class="nav-btn active" data-page="page-tap">
             <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,6H13V13H16L12,17L8,13H11V6M12,20C7.59,20 4,16.41 4,12H6A6,6 0 0,1 12,18A6,6 0 0,1 18,12H20C20,16.41 16.41,20 12,20Z" /></svg>
            Tap
        </button>
        <button class="nav-btn" data-page="page-task">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,13L14.5,15.5L12,18L9.5,15.5L12,13M8,5V7H11V5H8Z" /></svg>
            Tasks
        </button>
        <button class="nav-btn" data-page="page-withdraw">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
            Withdraw
        </button>
    </nav>

    <script>
        // Attempt to use Telegram WebApp SDK for user data
        const tg = window.Telegram?.WebApp;
        
        const app = {
            userData: {
                userName: "Guest",
                userId: null, // Store Telegram user ID if available
                joiningDate: new Date().toISOString(),
                points: 0,
                energy: 100,
                maxEnergy: 500, // Initial max energy
                energyPerTap: 1,   // Energy consumed per tap
                pointsPerTap: 1,   // Points gained per tap
                energyRegenRate: 1, // Energy points per second
                lastEnergyUpdate: Date.now(),
                tasks: [
                    { id: "yt1", name: "Watch Tech Review ðŸ“º", reward: 1000, completed: false, url: "https://www.youtube.com/embed/M7lc1qf-
                    ms" }, // Example: MKBHD video
                    { id: "yt2", name: "Learn Coding Basics ðŸ’»", reward: 1000, completed: false, url: "https://www.youtube.com/embed/zOjov-2OZ0E" }, // Example: FreeCodeCamp video
                    { id: "yt3", name: "SpaceX Starship Update ðŸš€", reward: 1000, completed: false, url: "https://www.youtube.com/embed/uRk339ablko" }, // Example: SpaceX video
                    { id: "yt4", name: "Funny Cat Compilation ðŸ˜¹", reward: 1000, completed: false, url: "https://www.youtube.com/embed/short-funny-cats" }, // Example: Placeholder for generic cat video
                    { id: "yt5", name: "Travel Vlog: Japan ðŸŒ¸", reward: 1000, completed: false, url: "https://www.youtube.com/embed/Iaoy3QEJ9n8" } // Example: Travel vlog
                ],
                referralLink: "t.me/xotswap_bot?start=REF_PLACEHOLDER",
                withdrawals: []
            },
            config: {
                localStorageKey: 'xotSwapData_v1' // Versioning for easier future migrations
            },

            init: function() {
                if (tg) {
                    tg.ready(); // Inform Telegram an app is ready
                    tg.expand(); // Expand the webapp to full height
                    // Use actual Telegram user data if available
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        const user = tg.initDataUnsafe.user;
                        this.userData.userName = user.first_name + (user.last_name ? ' ' + user.last_name : '') || user.username || "Telegram User";
                        this.userData.userId = user.id;
                        this.userData.referralLink = `https://t.me/xotswap_bot?start=${user.id}`;
                    }
                }

                this.loadData();
                this.initNavigation();
                this.updateAllDisplays();
                this.renderTasks();
                this.renderProfile();
                this.renderWithdrawHistory();

                document.getElementById('tap-button').addEventListener('click', (event) => this.handleTap(event));
                document.getElementById('withdraw-btn').addEventListener('click', () => this.handleWithdraw());
                
                setInterval(() => this.regenerateEnergy(), 1000); // Regenerate energy every second

                // Set initial active page (Tap page)
                this.showPage('page-tap'); 
                document.querySelector(`.nav-btn[data-page="page-tap"]`).classList.add('active');
            },

            loadData: function() {
                const savedData = localStorage.getItem(this.config.localStorageKey);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Carefully merge, prioritize existing tasks structure if IDs match
                    // to preserve task definitions, but update completion status
                    const currentTaskIds = this.userData.tasks.map(t => t.id);
                    const savedTasks = parsedData.tasks || [];
                    
                    this.userData = {
                        ...this.userData, // Start with defaults (e.g. new tasks are added)
                        ...parsedData,    // Override with saved data
                        tasks: this.userData.tasks.map(defaultTask => { // Merge tasks
                            const savedTask = savedTasks.find(st => st.id === defaultTask.id);
                            return savedTask ? { ...defaultTask, completed: savedTask.completed } : defaultTask;
                        })
                    };
                    // Ensure essential values are numbers
                    this.userData.points = Number(this.userData.points) || 0;
                    this.userData.energy = Number(this.userData.energy) || 0;
                    this.user
